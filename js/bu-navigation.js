var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var f={},m=this;return{listenFor:function(j,d){void 0===f[j]&&(f[j]=[]);f[j].push(d);return m},broadcast:function(j,d){var b;if(f[j])for(b=0;b<f[j].length;b+=1)f[j][b].apply(this,d||[]);return m}}}();bu.hooks=function(){var f={},m=this;return{addFilter:function(j,d){void 0===f[j]&&(f[j]=[]);f[j].push(d);return m},applyFilters:function(j,d){if(void 0===f[j])return d;var b=Array.prototype.slice.apply(arguments).slice(1),g=d,h;for(h=0;h<f[j].length;h+=1)g=f[j][h].apply(this,
b);return g}}}()})(jQuery);
(function(f){var m=bu.plugins.navigation;m.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0};f(document).ready(function(){!0===f.browser.msie&&7==parseInt(f.browser.version,10)&&f(document.body).addClass("ie7");!0===f.browser.msie&&8==parseInt(f.browser.version,10)&&f(document.body).addClass("ie8");!0===f.browser.msie&&9==parseInt(f.browser.version,10)&&f(document.body).addClass("ie9")});m.tree=function(f,d){"undefined"===typeof f&&(f="base");return m.trees[f](d).initialize()};
m.trees={base:function(j,d){var b={},d=d||{};f.extend(!0,b,bu.signals);b.config=f.extend({},m.settings,j||{});b.data={treeConfig:{},rollback:void 0};var g=b.config,h=b.data,c=b.$el=f(g.el);if(0===c.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(g.themePath&&document.images){var k=new Image,l=new Image;k.src=g.themePath+"/sprite.png";l.src=g.themePath+"/throbber.gif"}var k=function(a){return bu.hooks.applyFilters("canSelectNode",a)},l=function(a){return bu.hooks.applyFilters("canHoverNode",
a)},n=function(a){return bu.hooks.applyFilters("canDragNode",a)};h.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:l,start_drag:n},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:l,start_drag:n},section:{max_children:-1,max_depth:-1,valid_children:"all",
select_node:k,hover_node:l,start_drag:n},link:{max_children:0,max_depth:0,valid_children:"none",select_node:k,hover_node:l,start_drag:n},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:g.rpcUrl,type:"POST",data:function(a){return{child_of:a.attr?d.stripNodePrefix(a.attr("id")):0,post_types:g.postTypes,post_statuses:g.postStatuses,instance:g.instance,prefix:g.nodePrefix}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(a){var e=d.nodeToPost(a.o),
f=!0,c=!1===e.meta.excluded||"link"===e.type,e=!e.originalExclude&&(0===e.originalParent||"new"===e.status);-1===a.cr&&(!e&&c&&!g.allowTop)&&(f=!1);return bu.hooks.applyFilters("moveAllowed",f,a,b)}}},bu:{lazy_load:g.lazyLoad}};g.showCounts&&(h.treeConfig.json_data.progressive_render=!1);g.initialTreeData&&(h.treeConfig.json_data.data=g.initialTreeData);h.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",h.treeConfig,c);b.initialize=function(){c.jstree(h.treeConfig);return b};b.selectPost=function(a,
e){var e=e||!0,b=d.getNodeForPost(a);e&&c.jstree("deselect_all");c.jstree("select_node",b)};b.getSelectedPost=function(){var a=c.jstree("get_selected");return a.length?d.nodeToPost(a):!1};b.getPost=function(a){return(a=d.getNodeForPost(a))?d.nodeToPost(a):!1};b.getPosts=function(a){var e=[],r={},g,s;(a?f.jstree._reference(c)._get_node("#"+a):c).find("> ul > li").each(function(a,i){i=f(i);g=i.attr("id");s=i.data("post_type");"new"!=s&&(g=d.stripNodePrefix(g));r={ID:g,type:s,status:i.data("post_status"),
title:c.jstree("get_text",i),content:i.data("post_content"),meta:i.data("post_meta")};i.find("> ul > li").length&&(r.children=b.getPosts(i.attr("id")));e.push(r)});return e};b.showAll=function(){c.jstree("open_all")};b.hideAll=function(){c.jstree("close_all")};b.getPostLabel=function(a){a=d.getNodeForPost(a);return c.jstree("get_text",a)};b.setPostLabel=function(a,e){var b=d.getNodeForPost(a);c.jstree("set_text",b,e)};b.insertPost=function(a){var e;if("undefined"===typeof a)throw new TypeError("Post argument for insertPost must be defined!");
var b,f;a.parent=a.parent||0;a.menu_order=a.menu_order||1;e=a.parent?d.getNodeForPost(a.parent):c;b=a.menu_order-2;e=(b=0<=b?e.find("> ul > li").get(b):null)?"after":"before";f=d.postToNode(a);e=c.jstree("create",b,e,f,function(a){c.jstree("deselect_all");c.jstree("select_node",a)},!0);a.ID||(a.ID=e.attr("id"));return a};b.updatePost=function(a){var e=d.getNodeForPost(a),i;return e?(i=d.nodeToPost(e),a=f.extend(!0,{},i,a),c.jstree("set_text",e,a.title),e.data("post_content",a.content),e.data("post_title",
a.title),e.data("post_status",a.status),e.data("post_type",a.type),e.data("post_parent",parseInt(a.parent,10)),e.data("menu_order",parseInt(a.menu_order,10)),e.data("post_meta",a.meta),g.showStatuses&&p(e),b.broadcast("postUpdated",[a]),a):!1};b.removePost=function(a){a&&"undefined"===typeof a?(a=c.jstree("get_selected"),d.nodeToPost(a)):a=d.getNodeForPost(a);c.jstree("remove",a)};b.getAncestors=function(a){a=d.getNodeForPost(a);return c.jstree("get_path",a)};b.save=function(){h.rollback=c.jstree("get_rollback")};
b.restore=function(){"undefined"!==typeof h.rollback&&(f.jstree.rollback(h.rollback),h.rollback=c.jstree("get_rollback"))};d.nodeToPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid node!");var e=a.attr("id");-1===e.indexOf("post-new")&&(e=parseInt(d.stripNodePrefix(e),10));e={ID:e,title:c.jstree("get_text",a),content:a.data("post_content"),status:a.data("post_status"),type:a.data("post_type"),parent:parseInt(a.data("post_parent"),10),menu_order:a.index()+1,meta:a.data("post_meta")||
{},originalParent:parseInt(a.data("originalParent"),10),originalOrder:parseInt(a.data("originalOrder"),10),originalExclude:a.data("originalExclude")};return bu.hooks.applyFilters("nodeToPost",e,a)};d.postToNode=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");var e,a=f.extend({},{title:"(no title)",content:"",status:"new",type:"page",parent:0,menu_order:1,meta:{}},a);e=a.ID?g.nodePrefix+a.ID:"post-new-"+d.getNextPostID();return bu.hooks.applyFilters("postToNode",{attr:{id:e,
rel:a.type},data:{title:a.title},metadata:{post_status:a.status,post_type:a.type,post_content:a.content,post_parent:a.parent,menu_order:a.menu_order,post_meta:a.meta,originalParent:a.originalParent,originalOrder:a.originalOrder,originalExclude:a.originalExclude}},a)};d.getNodeForPost=function(a){if("undefined"===typeof a)throw new TypeError("Invalid post!");a=a&&"object"===typeof a?a.ID.toString():a.toString();-1===a.indexOf("post-new")&&(a=g.nodePrefix+a);a=f.jstree._reference(c)._get_node("#"+a);
return a.length?a:!1};d.getNextPostID=function(){return f('[id*="post-new-"]').length};d.stripNodePrefix=function(a){return a.replace(g.nodePrefix,"")};var i=function(a,e){var b,d,c,e=e||!0;b=a.find("li").length;c=a.children("a");b?(d=c.find("> .title-count > .count"),0===d.length&&(d=f('<span class="count"></span>'),c.children(".title-count").append(d)),d.text("("+b+")")):c.find("> .title-count > .count").remove();e&&a.find("> ul > li").each(function(){i(f(this))})},p=function(a){var e=a.children("a");
0===e.children(".post-statuses").length&&e.append('<span class="post-statuses"></span>');var a=d.nodeToPost(a),b=a.meta.excluded||!1,f=a.meta.restricted||!1,e=e.children(".post-statuses").empty(),c=[];"publish"!=a.status&&c.push({"class":a.status,label:a.status});b&&c.push({"class":"excluded",label:"not in nav"});f&&c.push({"class":"restricted",label:"restricted"});c=bu.hooks.applyFilters("navPostStatuses",c);for(a=0;a<c.length;a++)e.append('<span class="post_status '+c[a]["class"]+'">'+c[a].label+
"</span>")},q=function(a){0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section");g.showCounts&&(a=a.parent("ul").parent("div").attr("id")!=c.attr("id")?a.parents("li:last"):a,i(a))};c.bind("loaded.jstree",function(){var a=c.find("> ul > li:first-child"),a=18<=a.height()?a.height():32;c.jstree("data").data.core.li_height=a;b.broadcast("postsLoaded")});c.bind("reselect.jstree",function(){c.data("initial-save")||(c.data("initial-save",!0),b.save());b.broadcast("postsSelected")});c.bind("load_node.jstree",
function(a,b){if(-1!==b.rslt.obj){var c=b.rslt.obj;g.showCounts&&i(c)}});g.showStatuses&&c.bind("clean_node.jstree",function(a,b){var c=b.rslt.obj;c&&-1!==c&&c.each(function(a,b){var e=f(b);0===e.find("> a > .post-statuses").length&&p(e)})});c.bind("create_node.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj);b.broadcast("postCreated",[c])});c.bind("select_node.jstree",function(a,e){var c=d.nodeToPost(e.rslt.obj);b.broadcast("selectPost",[c,b])});c.bind("create.jstree",function(a,e){var c=e.rslt.parent,
f=e.rslt.position,g=d.nodeToPost(e.rslt.obj),i=null;-1!==c&&(i=d.nodeToPost(c),q(c));g.parent=i?i.ID:0;g.menu_order=f+1;b.broadcast("postInserted",[g])});c.bind("remove.jstree",function(a,c){var g=c.rslt.obj,i=d.nodeToPost(g),h=c.rslt.parent,j;-1!==h&&q(h);b.broadcast("postRemoved",[i]);g.find("li").each(function(){(j=d.nodeToPost(f(this)))&&b.broadcast("postRemoved",[j])})});c.bind("deselect_node.jstree",function(a,c){var f=d.nodeToPost(c.rslt.obj);b.broadcast("deselectPost",[f,b])});c.bind("move_node.jstree",
function(a,e){e.rslt.o.each(function(a,g){var i=f(g),h=d.nodeToPost(i),j=e.rslt.np,k=e.rslt.op,i=i.index()+1,l=0,m=0,n=1;c.attr("id")!==j.attr("id")&&(q(j),l=parseInt(d.stripNodePrefix(j.attr("id")),10));c.attr("id")!==k.attr("id")&&!j.is("#"+k.attr("id"))&&(q(k),j=d.nodeToPost(k),m=j.ID);n=h.menu_order;h.parent=l;h.menu_order=i;b.updatePost(h);b.broadcast("postMoved",[h,m,n])})});k=function(a){var b=f.contains(c[0],a.target),a=f.contains(f("#vakata-contextmenu")[0],a.target);!b&&!a&&c.jstree("deselect_all")};
g.deselectOnDocumentClick&&f(document).bind("click",k);return b},navman:function(j,d){var b={},d=d||{},b=m.trees.base(j,d),g=b.$el,h=b.data;h.treeConfig.plugins.push("contextmenu");h.treeConfig.contextmenu={show_at_node:!1,items:function(b){return bu.hooks.applyFilters("navmanContextItems",{edit:{label:"Edit",action:c,icon:"remove"},remove:{label:"Remove",action:k}},b)}};var c=function(c){c=d.nodeToPost(c);b.broadcast("editPost",[c])},k=function(c){c=d.nodeToPost(c);b.removePost(c)};g.bind("loaded.jstree",
function(){g.undelegate("a","contextmenu.jstree")});g.bind("clean_node.jstree",function(c,b){var d=b.rslt.obj;d&&-1!=d&&d.each(function(a,c){var b=f(c).children("a");if(!b.children(".edit-options").length){var d=f('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),g=b.children(".post-statuses");g.length?g.before(d):b.append(d)}})});var l=null;g.delegate(".edit-options","click",function(b){b.preventDefault();b.stopPropagation();var b=f(this).offset(),c=f(this).height()+
5,d=f(this).parent("a").parent("li");g.jstree("deselect_all");f(this).addClass("clicked");g.jstree("select_node",d);g.jstree("show_contextmenu",d,b.left,b.top+c);l&&l.attr("id")!=d.attr("id")&&n(l);l=d});f(document).bind("context_hide.vakata",function(){n(l)});var n=function(b){b&&b.find("> a > .edit-options").removeClass("clicked")};return b},edit_post:function(j,d){var d=d||{},b=m.trees.base(j,d),g=b.data,h=f.extend(b.config,j||{}),c=b.$el,k=h.currentPost,l={},n=[],i;if(h.ancestors&&h.ancestors.length){var p=
h.ancestors.reverse();for(i=0;i<p.length;i+=1)n.push("#"+h.nodePrefix+h.ancestors[i])}n.length&&(l.core={initially_open:n});f.extend(!0,g.treeConfig,l);g=function(b){return d.stripNodePrefix(b.attr("id"))==k.ID};bu.hooks.addFilter("canSelectNode",g);bu.hooks.addFilter("canHoverNode",g);bu.hooks.addFilter("canDragNode",g);c.bind("reselect.jstree",function(){d.getNodeForPost(k)||"new"===k.status&&b.insertPost(k);b.selectPost(k);b.save()});b.getCurrentPost=function(){var b;return(b=d.getNodeForPost(k))?
b=d.nodeToPost(b):!1};b.setCurrentPost=function(b){k=b};b.scrollToSelection=function(){var b=c.jstree("get_selected");if(b.length){f(document);c.css("overflow");var a=c.innerHeight(),b=b.position().top+b.height()/2-a/2;0<b&&c.scrollTop(b)}};return b}}})(jQuery);