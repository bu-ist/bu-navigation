var bu=bu||{};bu.plugins=bu.plugins||{};bu.plugins.navigation={};
(function(){bu.signals=function(){var c={},n=this;return{listenFor:function(i,d){void 0===c[i]&&(c[i]=[]);c[i].push(d);return n},broadcast:function(i,d){var a;if(c[i])for(a=0;a<c[i].length;a+=1)c[i][a].apply(this,d||[]);return n}}}();bu.hooks=function(){var c={},n=this;return{addFilter:function(i,d){void 0===c[i]&&(c[i]=[]);c[i].push(d);return n},applyFilters:function(i,d){if(void 0===c[i])return d;var a=Array.prototype.slice.apply(arguments).slice(1),e=d,g;for(g=0;g<c[i].length;g+=1)e=c[i][g].apply(this,
a);return e}}}()})(jQuery);
(function(c){var n=bu.plugins.navigation;n.settings={lazyLoad:!1,showCounts:!1};c(document).ready(function(){!0===c.browser.msie&&7==parseInt(c.browser.version,10)&&c(document.body).addClass("ie7");!0===c.browser.msie&&8==parseInt(c.browser.version,10)&&c(document.body).addClass("ie8");!0===c.browser.msie&&9==parseInt(c.browser.version,10)&&c(document.body).addClass("ie9")});n.tree=function(c,d){"undefined"===typeof c&&(c="base");return n.trees[c](d).initialize()};n.trees={base:function(i,d){var a=
{},d=d||{};c.extend(!0,a,bu.signals);a.config=c.extend({},n.settings,i||{});a.data={treeConfig:{},rollback:void 0};var e=a.config,g=a.data,f=a.$el=c(e.el);if(0===f.length)throw new TypeError("Invalid DOM selector, can't create BU Navigation Tree");if(e.themePath&&document.images){var k=new Image,m=new Image;k.src=e.themePath+"/sprite.png";m.src=e.themePath+"/throbber.gif"}var k=function(b){return bu.hooks.applyFilters("canSelectNode",b)},m=function(b){return bu.hooks.applyFilters("canHoverNode",b)},
p=function(b){return bu.hooks.applyFilters("canDragNode",b)};g.treeConfig={plugins:"themes types json_data ui dnd crrm bu".split(" "),core:{animation:0,html_titles:!0},themes:{theme:"bu",load_css:!1},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:m,start_drag:p},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:m,start_drag:p},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:k,hover_node:m,start_drag:p},
link:{max_children:0,max_depth:0,valid_children:"none",select_node:k,hover_node:m,start_drag:p},denied:{select_node:!1,hover_node:!1,start_drag:!1}}},json_data:{ajax:{url:e.rpcUrl,type:"POST",data:function(b){return{id:b.attr?d.stripNodePrefix(b.attr("id")):0,instance:e.instance,prefix:e.nodePrefix,post_status:e.postStatuses}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(b){var j=d.nodeToPost(b.o),l=!0;-1===b.cr&&(!1===j.meta.excluded&&!e.allowTop)&&(l=!1);return bu.hooks.applyFilters("moveAllowed",
l,b,a)}}},bu:{lazy_load:e.lazyLoad}};e.showCounts&&(g.treeConfig.json_data.progressive_render=!1);e.initialTreeData&&(g.treeConfig.json_data.data=e.initialTreeData);g.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",g.treeConfig,f);a.initialize=function(){f.jstree(g.treeConfig);return a};a.selectPost=function(b,j){var j=j||!0,a=d.getNodeForPost(b);j&&f.jstree("deselect_all");f.jstree("select_node",a)};a.getSelected=function(){var b=f.jstree("get_selected");return d.nodeToPost(b)};a.getPost=function(b){b=
d.getNodeForPost(b);return d.nodeToPost(b)};a.getPosts=function(b){var j=[],l={},e,s;(b?c.jstree._reference(f)._get_node("#"+b):f).find("> ul > li").each(function(b,h){h=c(h);e=h.attr("id");s=h.data("post_type");"new"!=s&&(e=d.stripNodePrefix(e));l={ID:e,type:s,status:h.data("post_status"),title:f.jstree("get_text",h),content:h.data("post_content"),meta:h.data("post_meta")};h.find("> ul > li").length&&(l.children=a.getPosts(h.attr("id")));j.push(l)});return j};a.showAll=function(){f.jstree("open_all")};
a.hideAll=function(){f.jstree("close_all")};a.getPostLabel=function(b){b=d.getNodeForPost(b);return f.jstree("get_text",b)};a.setPostLabel=function(b,j){var a=d.getNodeForPost(b);f.jstree("set_text",a,j)};a.insertPost=function(b,j){var a=f.jstree("get_selected"),h=0<a.length,a=c.extend({which:h?a:null,position:h?"after":"before",skip_rename:!0,callback:function(b){f.jstree("deselect_all");f.jstree("select_node",b)}},j),h=d.postToNode(b);f.jstree("create",a.which,a.position,h,a.callback,a.skip_rename);
return b};a.updatePost=function(b){var j=d.getNodeForPost(b),l;j&&(l=d.nodeToPost(j),l=c.extend(!0,{},l,b),f.jstree("set_text",j,l.title),j.data("post_content",l.content),j.data("post_title",l.title),j.data("post_status",l.status),j.data("post_type",l.type),j.data("post_parent",parseInt(l.parent,10)),j.data("menu_order",parseInt(l.menu_order,10)),j.data("post_meta",l.meta));r(j);a.broadcast("updatePost",[l]);return l};a.removePost=function(b){b&&"undefined"===typeof b?(b=f.jstree("get_selected"),
d.nodeToPost(b)):b=d.getNodeForPost(b);f.jstree("remove",b)};a.getAncestors=function(b){b=d.getNodeForPost(b);return f.jstree("get_path",b)};a.save=function(){g.rollback=f.jstree("get_rollback")};a.restore=function(){"undefined"!==typeof g.rollback&&(c.jstree.rollback(g.rollback),g.rollback=f.jstree("get_rollback"))};d.nodeToPost=function(b){if("undefined"===typeof b)throw new TypeError("Invalid node!");var a=b.attr("id");-1===a.indexOf("post-new")&&(a=parseInt(d.stripNodePrefix(a),10));b={ID:a,title:f.jstree("get_text",
b),content:b.data("post_content"),status:b.data("post_status"),type:b.data("post_type"),parent:parseInt(b.data("post_parent"),10),menu_order:parseInt(b.data("menu_order"),10),meta:b.data("post_meta")||{}};return bu.hooks.applyFilters("nodeToPost",b)};d.postToNode=function(b){if("undefined"===typeof b)throw new TypeError("Invalid post!");var a={ID:d.getNextPostID(),title:"Untitled Post",content:"",status:"new",type:"page",parent:0,menu_order:0,meta:{}},b=c.extend({},a,b);return bu.hooks.applyFilters("postToNode",
{attr:{id:b.ID?e.nodePrefix+b.ID:"post-new-"+b.ID,rel:b.type},data:{title:b.title},metadata:{post_status:b.status,post_type:b.type,post_content:b.content,post_parent:b.parent,menu_order:b.menu_order,post_meta:b.meta}})};d.getNodeForPost=function(b){if("undefined"===typeof b)throw new TypeError("Invalid post!");b=b&&"object"===typeof b?b.ID.toString():b.toString();-1===b.indexOf("post-new")&&(b=e.nodePrefix+b);b=c.jstree._reference(f)._get_node("#"+b);return b.length?b:!1};d.getNextPostID=function(){return c('[id*="post-new-"]').length};
d.stripNodePrefix=function(b){return b.replace(e.nodePrefix,"")};var h=function(b,a){"undefined"===typeof a&&(a=!0);var d=b.find("li").length,f=b.children("a");if(d){var e=f.children(".count");if(0===e.length){var q=f.children(".edit-options"),e=c('<span class="count"></span>');q.length?q.before(e):f.append(e)}e.text("("+d+")")}else f.children(".count").remove();a&&b.find("> ul > li").each(function(){h(c(this))})},r=function(b){var a=b.children("a");0===a.children(".post-statuses").length&&a.append('<span class="post-statuses"></span>');
var b=d.nodeToPost(b),c=b.meta.excluded||!1,f=b.meta.restricted||!1,a=a.children(".post-statuses").empty(),e=[];"publish"!=b.status&&e.push({"class":b.status,label:b.status});c&&e.push({"class":"excluded",label:"not in nav"});f&&e.push({"class":"restricted",label:"restricted"});e=bu.hooks.applyFilters("navPostStatuses",e);for(b=0;b<e.length;b++)a.append('<span class="post_status '+e[b]["class"]+'">'+e[b].label+"</span>")},q=function(b){var a;0===b.children("ul").length?b.attr("rel","page"):b.attr("rel",
"section");e.showCounts&&(a=b.parentsUntil("#"+f.attr("id"),"li"),a=a.length?a.last():b,h(a))};f.bind("loaded.jstree",function(){var b=f.find("> ul > li:first-child"),b=18<=b.height()?b.height():32;f.jstree("data").data.core.li_height=b;a.broadcast("postsLoaded")});f.bind("reselect.jstree",function(){f.data("initial-save")||(f.data("initial-save",!0),a.save());a.broadcast("postsSelected")});f.bind("load_node.jstree",function(b,a){if(-1!==a.rslt.obj){var d=a.rslt.obj;e.showCounts&&h(d)}});f.bind("clean_node.jstree",
function(b,a){var d=a.rslt.obj;d&&-1!==d&&d.each(function(b,a){var d=c(a);0===d.find("> a > .post-statuses").length&&r(d)})});f.bind("create_node.jstree",function(b,c){var e=d.nodeToPost(c.rslt.obj);a.broadcast("postCreated",[e])});f.bind("select_node.jstree",function(b,c){var e=d.nodeToPost(c.rslt.obj);a.broadcast("selectPost",[e,a])});f.bind("create.jstree",function(b,c){var e=c.rslt.parent,f=c.rslt.position,h=d.nodeToPost(c.rslt.obj),g=null;-1!==e&&(g=d.nodeToPost(e),q(e));h.parent=g?g.ID:0;h.menu_order=
f+1;a.broadcast("insertPost",[h])});f.bind("remove.jstree",function(b,c){var e=d.nodeToPost(c.rslt.obj),f=c.rslt.parent;-1!==f&&q(f);a.broadcast("removePost",[e])});f.bind("deselect_node.jstree",function(b,c){var e=d.nodeToPost(c.rslt.obj);a.broadcast("deselectPost",[e,a])});f.bind("move_node.jstree",function(b,c){var e=d.nodeToPost(c.rslt.o),h=c.rslt.np,g=c.rslt.op,i=c.rslt.o.index()+1,k=0;f.attr("id")!==h.attr("id")&&(q(h),k=parseInt(d.stripNodePrefix(h.attr("id")),10));f.attr("id")!==g.attr("id")&&
!h.is("#"+g.attr("id"))&&q(g);e.parent=k;e.menu_order=i;a.updatePost(e);a.broadcast("postMoved",[e,k,i])});return a},navman:function(i,d){var a={},d=d||{},a=n.trees.base(i,d),e=a.$el,g=a.data;g.treeConfig.plugins.push("contextmenu");g.treeConfig.contextmenu={show_at_node:!1,items:function(){return{edit:{label:"Edit",action:f,icon:"remove"},remove:{label:"Remove",action:k}}}};var f=function(c){c=d.nodeToPost(c);a.broadcast("editPost",[c])},k=function(c){c=d.nodeToPost(c);a.removePost(c)};e.bind("loaded.jstree",
function(){e.undelegate("a","contextmenu.jstree")});e.bind("clean_node.jstree",function(a,e){var d=e.rslt.obj;d&&-1!=d&&d.each(function(b,a){var e=c(a).children("a");if(!e.children(".edit-options").length){var d=c('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>options</button>'),f=e.children(".post-statuses");f.length?f.before(d):e.append(d)}})});var m=null;e.delegate(".edit-options","click",function(a){a.preventDefault();a.stopPropagation();var a=c(this).offset(),d=c(this).height()+
5,f=c(this).parent("a").parent("li");e.jstree("deselect_all");c(this).addClass("clicked");e.jstree("select_node",f);e.jstree("show_contextmenu",f,a.left,a.top+d);m&&m.attr("id")!=f.attr("id")&&p(m);m=f});c(document).bind("context_hide.vakata",function(){p(m)});var p=function(a){a&&a.find("> a > .edit-options").removeClass("clicked")};c(document).bind("click",function(a){var d=c.contains(e[0],a.target),a=c.contains(c("#vakata-contextmenu")[0],a.target);!d&&!a&&e.jstree("deselect_all")});return a},
edit_post:function(i,d){var d=d||{},a=n.trees.base(i,d),e=a.data,g=c.extend(a.config,i||{}),f=a.$el,k=g.currentPost,m={},p=[],h;if(g.ancestors&&g.ancestors.length){var r=g.ancestors.reverse();for(h=0;h<r.length;h+=1)p.push("#"+g.nodePrefix+g.ancestors[h])}p.length&&(m.core={initially_open:p});c.extend(!0,e.treeConfig,m);e=function(a){return d.stripNodePrefix(a.attr("id"))==k.ID};bu.hooks.addFilter("canSelectNode",e);bu.hooks.addFilter("canHoverNode",e);bu.hooks.addFilter("canDragNode",e);f.bind("reselect.jstree",
function(){d.getNodeForPost(k)||"new"===k.status&&a.insertPost(k,{pos:"before"});a.selectPost(k);a.save()});a.getCurrentPost=function(){if(null===k||"undefined"===typeof k)return!1;var a=d.getNodeForPost(k);return a?d.nodeToPost(a):!1};a.setCurrentPost=function(a){k=a};a.scrollToSelection=function(){var a=f.jstree("get_selected");if(a.length){c(document);f.css("overflow");var b=f.innerHeight(),a=a.position().top+a.height()/2-b/2;0<a&&f.scrollTop(a)}};return a}}})(jQuery);