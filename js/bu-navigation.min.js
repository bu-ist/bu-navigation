var bu=bu||{};bu.plugins=bu.plugins||{},bu.plugins.navigation={},function(t){"use strict";var o,r;bu.signals=(o={listenFor:function(e,t){var o=this._listeners;void 0===o[e]&&(o[e]=[]),o[e].push(t)},broadcast:function(e,t){var o,n=this._listeners;if(n[e])for(o=0;o<n[e].length;o+=1)n[e][o].apply(this,t||[])}},{register:function(e){e._listeners={},t.extend(!0,e,o)}}),bu.hooks=(r={},{addFilter:function(e,t){return void 0===r[e]&&(r[e]=[]),r[e].push(t),this},applyFilters:function(e,t){if(void 0===r[e])return t;for(var o=Array.prototype.slice.apply(arguments).slice(1),n=t,s=0;s<r[e].length;s+=1)n=r[e][s].apply(this,o);return n}})}(jQuery),function(g){var v=bu.plugins.navigation;v.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0},v.tree=function(e,t){return void 0===e&&(e="base"),v.trees[e](t).initialize()},v.trees={base:function(e,u){var p={};u=u||{},bu.signals.register(p),p.config=g.extend({},v.settings,e||{}),p.data={treeConfig:{},rollback:void 0};var t,o,r=p.config,n=p.data,f=p.$el=g(r.el);r.themePath&&document.images&&(t=new Image,o=new Image,t.src=r.themePath+"/sprite.png",o.src=r.themePath+"/throbber.gif");function s(e){return bu.hooks.applyFilters("canSelectNode",e,p)}function a(e){return bu.hooks.applyFilters("canHoverNode",e,p)}function i(e){return bu.hooks.applyFilters("canDragNode",e,p)}n.treeConfig={plugins:["themes","types","json_data","ui","dnd","crrm","bu"],core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},dnd:{drag_container:document},types:{types:{default:{max_children:-1,max_depth:-1,valid_children:"all",select_node:s,hover_node:a,start_drag:i},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:s,hover_node:a,start_drag:i},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:s,hover_node:a,start_drag:i},link:{max_children:0,max_depth:0,valid_children:"none",select_node:s,hover_node:a,start_drag:i}}},json_data:{ajax:{url:r.rpcUrl,type:"POST",data:function(e){var t=-1===e?{ID:0}:u.nodeToPost(e);return{child_of:t.ID,post_types:r.postTypes,post_statuses:r.postStatuses,instance:r.instance,prefix:r.nodePrefix,include_links:r.includeLinks}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(e){var t=u.nodeToPost(e.o),o=-1===e.cr,n=!1===t.post_meta.excluded||t.post_type===r.linksPostType,s=!0;return o&&n&&!r.allowTop&&(s=!1),bu.hooks.applyFilters("moveAllowed",s,e,p)}}},bu:{lazy_load:r.lazyLoad}},r.showCounts&&(n.treeConfig.json_data.progressive_render=!1),r.initialTreeData&&(n.treeConfig.json_data.data=r.initialTreeData),n.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",n.treeConfig,f),p.initialize=function(){return f.jstree(n.treeConfig),p},p.openPost=function(e,t){var o=u.getNodeForPost(e);if(t=t||g.noop,!o)return!1;f.jstree("open_node",o,t,!0)},p.selectPost=function(e,t){t=t||!0;var o=u.getNodeForPost(e);t&&f.jstree("deselect_all"),f.jstree("select_node",o)},p.getSelectedPost=function(){var e=f.jstree("get_selected");return!!e.length&&u.nodeToPost(e)},p.deselectAll=function(){f.jstree("deselect_all")},p.getPost=function(e){var t=u.getNodeForPost(e);return!!t&&u.nodeToPost(t)},p.getPosts=function(e){var o=[],n={},t=e?g.jstree._reference(f)._get_node("#"+e):f;return t.find("> ul > li").each(function(e,t){t=g(t),n=u.nodeToPost(t),t.find("> ul > li").length&&(n.children=p.getPosts(t.attr("id"))),o.push(n)}),o},p.showAll=function(){f.jstree("open_all")},p.hideAll=function(){f.jstree("close_all")},p.getPostLabel=function(e){var t=u.getNodeForPost(e);return f.jstree("get_text",t)},p.setPostLabel=function(e,t){var o=u.getNodeForPost(e);f.jstree("set_text",o,t)},p.insertPost=function(e,t){if(void 0===e)throw new TypeError("Post argument for insertPost must be defined!");var o,n,s,r,a,i,d,l;return e.post_parent=e.post_parent||0,e.menu_order=e.menu_order||1,e.post_parent?(n=u.getNodeForPost(e.post_parent),r=p.getPost(e.post_parent)):n=f,1==e.menu_order?(s=n.find("> ul > li").get(0),l="before"):0<=(a=e.menu_order-2)&&(s=n.find("> ul > li").get(a),l="after"),s||(s=n,l="inside"),i={which:s,position:l,callback:t||function(e){f.jstree("deselect_all"),f.jstree("select_node",e)}},e=bu.hooks.applyFilters("preInsertPost",e,r),d=u.postToNode(e),o=f.jstree("create_node",i.which,i.position,d,i.callback),e.ID||(e.ID=o.attr("id")),e},p.updatePost=function(e){var t,o,n=u.getNodeForPost(e);return!!n&&(t=u.nodeToPost(n),o=g.extend(!0,{},t,e),f.jstree("set_text",n,o.post_title),o.post_parent=parseInt(o.post_parent,10),o.menu_order=parseInt(o.menu_order,10),n.data("post",o),r.showStatuses&&n.find("li").andSelf().each(function(){_(g(this))}),p.broadcast("postUpdated",[o]),o)},p.removePost=function(e){var t;e&&void 0===e?(t=f.jstree("get_selected"),e=u.nodeToPost(t)):t=u.getNodeForPost(e),f.jstree("remove",t)},p.getAncestors=function(e){var t=u.getNodeForPost(e);return!1!==t&&f.jstree("get_path",t)},p.save=function(){n.rollback=f.jstree("get_rollback")},p.restore=function(){void 0!==n.rollback&&(n.rollback.d.ui.selected=g([]),g.jstree.rollback(n.rollback),n.rollback=f.jstree("get_rollback"))},p.lock=function(){f.jstree("lock")},p.unlock=function(){f.jstree("unlock")},u.nodeToPost=function(e){if(void 0===e)throw new TypeError("Invalid node!");var t=e.attr("id"),o=g.extend({},!0,e.data("post"));return-1===t.indexOf("post-new")&&(t=parseInt(u.stripNodePrefix(t),10)),o.ID=t,o.post_title=f.jstree("get_text",e),o.menu_order=e.index()+1,o.post_parent=parseInt(o.post_parent,10),o.originalParent=parseInt(o.originalParent,10),o.originalOrder=parseInt(o.originalOrder,10),o.post_meta=o.post_meta||{},bu.hooks.applyFilters("nodeToPost",o,e)},u.postToNode=function(e,t){if(void 0===e)throw new TypeError("Invalid post!");var t=t||!1,o={post_title:"(no title)",post_content:"",post_status:"new",post_type:"page",post_parent:0,menu_order:1,post_meta:{},url:""},n=g.extend({},o,e),s={attr:{id:n.ID?r.nodePrefix+n.ID:"post-new-"+u.getNextPostID(),rel:u.getRelAttrForPost(e,t)},data:{title:n.post_title},metadata:{post:n}};return bu.hooks.applyFilters("postToNode",s,n)},u.getNodeForPost=function(e){return void 0!==e&&(e&&"object"==typeof e?-1===(t=e.ID.toString()).indexOf("post-new")&&(t=r.nodePrefix+t):-1===(t=e.toString()).indexOf("post-new")&&(t=r.nodePrefix+t),!!(o=g.jstree._reference(f)._get_node("#"+t)).length&&o);var t,o},u.getNextPostID=function(){return g('[id*="post-new-"]').length},u.stripNodePrefix=function(e){return e.replace(r.nodePrefix,"")},u.getRelAttrForPost=function(e,t){var o=t?"section":e.post_type==r.linksPostType?"link":"page";return o};function d(e){var t,o,n,s;if(e=e||!1,t={excluded:{class:"excluded",label:r.statusBadgeExcluded,inherited:!1},protected:{class:"protected",label:r.statusBadgeProtected,inherited:!1}},s=o=bu.hooks.applyFilters("navStatusBadges",t),e)for(n in s={},o)o[n].hasOwnProperty("inherited")&&o[n].inherited&&(s[n]=o[n]);return s}function h(e){var t;0===e.children("ul").length?e.attr("rel","page"):e.attr("rel","section"),r.showCounts&&(t=e.parent("ul").parent("div").attr("id")!=f.attr("id")?e.parents("li:last"):e,l(t,!0))}var l=function(e,t){var o=e.find("li").length;c(e,o),t&&e.find("li").each(function(){l(g(this))})},c=function(e,t){var o,n=e.children("a");0===n.children(".title-count").children(".count").length&&n.children(".title-count").append('<span class="count"></span>'),o=n.find("> .title-count > .count").empty(),t?o.text("("+t+")"):o.text("")},_=function(e){var t,o,n,s,r,a,i=e.children("a");for(r in 0===i.children(".post-statuses").length&&i.append('<span class="post-statuses"></span>'),o=i.children(".post-statuses").empty(),t=u.nodeToPost(e),n=[],function(e){u.nodeToPost(e);var t,o=d({inherited:!0});for(t in o)e.parentsUntil("#"+f.attr("id"),"li").filter(function(){return g(this).data("post").post_meta[t]||g(this).data("inherited_"+t)}).length?e.data("inherited_"+t,!0):e.removeData("inherited_"+t)}(e),"publish"!=t.post_status&&n.push({class:t.post_status,label:t.post_status}),s=d())(t.post_meta[r]||e.data("inherited_"+r))&&n.push({class:s[r].class,label:s[r].label});for(a=0;a<n.length;a+=1)o.append('<span class="post_status '+n[a].class+'">'+n[a].label+"</span>")};f.on("loaded.jstree",function(e,t){var o=f.find("> ul > li:first-child"),n=18<=o.height()?o.height():32;f.jstree("data").data.core.li_height=n,p.broadcast("postsLoaded")}),f.on("reselect.jstree",function(e,t){p.broadcast("postsSelected")}),f.on("lazy_loaded.jstree",function(e,t){p.broadcast("lazyLoadComplete")}),f.on("load_node.jstree",function(e,t){var o;-1!==t.rslt.obj&&(o=t.rslt.obj,r.showCounts&&l(o,!0))}),f.on("clean_node.jstree",function(e,t){var o=t.rslt.obj;o&&-1!==o&&o.each(function(e,t){var o=g(t);o.data("buNavExtrasAdded")||(r.showStatuses&&_(o),o.data("buNavExtrasAdded",!0))})}),f.on("before.jstree",function(e,t){var o;switch(t.func){case"select_node":case"hover_node":case"start_drag":if((o=t.inst._get_node(t.args[0]))&&o.hasClass("denied"))return!1}}),f.on("create_node.jstree",function(e,t){var o=t.rslt.obj,n=u.nodeToPost(o);p.broadcast("postCreated",[n])}),f.on("select_node.jstree",function(e,t){var o=u.nodeToPost(t.rslt.obj);p.broadcast("postSelected",[o])}),f.on("create.jstree",function(e,t){var o=t.rslt.obj,n=t.rslt.parent,s=t.rslt.position,r=u.nodeToPost(o),a=null;-1!==n&&(a=u.nodeToPost(n),h(n)),r.post_parent=a?a.ID:0,r.menu_order=s+1,p.broadcast("postInserted",[r])}),f.on("remove.jstree",function(e,t){var o,n=t.rslt.obj,s=u.nodeToPost(n),r=t.rslt.parent;-1!==r&&h(r),p.broadcast("postRemoved",[s]),n.find("li").each(function(){(o=u.nodeToPost(g(this)))&&p.broadcast("postRemoved",[o])})}),f.on("deselect_node.jstree",function(e,t){var o=u.nodeToPost(t.rslt.obj);p.broadcast("postDeselected",[o])}),f.on("deselect_all.jstree",function(e,t){p.broadcast("postsDeselected")}),f.on("move_node.jstree",function(e,c){c.rslt.o.each(function(e,t){var o,n=g(t),s=u.nodeToPost(n),r=c.rslt.np,a=c.rslt.op,i=n.index()+1,d=0,l=0;f.attr("id")!==r.attr("id")&&(h(r),d=parseInt(u.stripNodePrefix(r.attr("id")),10)),f.attr("id")===a.attr("id")||r.is("#"+a.attr("id"))||(h(a),l=u.nodeToPost(a).ID),o=s.menu_order,s.post_parent=d,s.menu_order=i,p.updatePost(s),p.broadcast("postMoved",[s,l,o])})});return r.deselectOnDocumentClick&&g(document).on("click",function(e){var t,o;void 0!==f[0]&&(t=g.contains(f[0],e.target),o=g.contains(g("#vakata-contextmenu")[0],e.target),t||o||f.jstree("deselect_all"))}),p},navman:function(e,n){var o={};n=n||{};var i=(o=v.trees.base(e,n)).$el,t=o.data,r=o.config,s=function(e){var t=n.nodeToPost(e);o.broadcast("editPost",[t])},a=function(e){var t=n.nodeToPost(e);t.url&&window.open(t.url)},d=function(e){var t=n.nodeToPost(e);o.removePost(t)};t.treeConfig.plugins.push("contextmenu"),t.treeConfig.contextmenu={show_at_node:!1,items:function(e){var t=n.nodeToPost(e),o={edit:{label:r.optionsEditLabel,action:s},view:{label:r.optionsViewLabel,action:a},remove:{label:r.optionsTrashLabel,action:d}};return t.url||delete o.view,t.post_type===r.linksPostType&&(o.remove.label=r.optionsDeleteLabel),bu.hooks.applyFilters("navmanOptionsMenuItems",o,e)}},i.bind("loaded.jstree",function(e,t){i.undelegate("a","contextmenu.jstree")}),i.bind("clean_node.jstree",function(e,t){var o=t.rslt.obj;o&&-1!=o&&o.each(function(e,t){var o,n,s=g(t).children("a");s.children(".edit-options").length||(o=g('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>'+r.optionsLabel+"</button>"),(n=s.children(".post-statuses")).length?n.before(o):s.append(o))})});var l=null;i.delegate(".edit-options","click",function(e){var t,o,n,s,r,a;e.preventDefault(),e.stopPropagation(),t=g(this).offset(),o=g(this).outerWidth(),n=g(this).outerHeight(),s=t.top,s+=n,r=t.left+o-180,a=g(this).closest("li"),i.jstree("deselect_all"),i.jstree("select_node",a),i.jstree("show_contextmenu",a,r,s),g(this).addClass("clicked"),l&&l.attr("id")!==a.attr("id")&&c(l),l=a}),g(document).on("context_hide.vakata",function(e,t){c(l)});var c=function(e){e&&e.find("> a > .edit-options").removeClass("clicked")};return i.addClass("bu-navman"),o},edit_post:function(e,o){o=o||{};var n=v.trees.base(e,o),t=n.data,s=g.extend(n.config,e||{}),r=n.$el,a=s.currentPost,i={};i.dnd={drag_container:s.treeDragContainer},g.extend(!0,t.treeConfig,i);function d(e,t){if(t.$el.is(n.$el.selector))return o.stripNodePrefix(e.attr("id"))==a.ID}bu.hooks.addFilter("canSelectNode",d),bu.hooks.addFilter("canHoverNode",d),bu.hooks.addFilter("canDragNode",d),r.bind("loaded.jstree",function(e,t){var o;s.ancestors&&s.ancestors.length?(o=s.ancestors.reverse(),l(0,o)):c()});var l=function(t,o){var e=o[t];e?!1===n.openPost(e,function(){l(t+1,o)})&&n.insertPost(e,function(e){l(t+1,o)}):c()},c=function(){o.getNodeForPost(a)?(n.selectPost(a),n.save()):n.insertPost(a,function(e){n.selectPost(a),n.save()})};return n.getCurrentPost=function(){var e=o.getNodeForPost(a);return!!e&&o.nodeToPost(e)},n.setCurrentPost=function(e){a=e},r.addClass("bu-edit-post"),n}}}(jQuery);