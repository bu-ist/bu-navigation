var bu=bu||{};bu.plugins=bu.plugins||{},bu.plugins.navigation={},function(t){"use strict";var o,r;bu.signals=(o={listenFor:function(e,t){var o=this._listeners;void 0===o[e]&&(o[e]=[]),o[e].push(t)},broadcast:function(e,t){var o,n=this._listeners;if(n[e])for(o=0;o<n[e].length;o+=1)n[e][o].apply(this,t||[])}},{register:function(e){e._listeners={},t.extend(!0,e,o)}}),bu.hooks=(r={},{addFilter:function(e,t){return void 0===r[e]&&(r[e]=[]),r[e].push(t),this},applyFilters:function(e,t){if(void 0===r[e])return t;for(var o=Array.prototype.slice.apply(arguments).slice(1),n=t,s=0;s<r[e].length;s+=1)n=r[e][s].apply(this,o);return n}})}(jQuery),function(h){var _=bu.plugins.navigation;_.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0},_.tree=function(e,t){return _.trees[e=void 0===e?"base":e](t).initialize()},_.trees={base:function(e,c){function t(e){return bu.hooks.applyFilters("canSelectNode",e,l)}function o(e){return bu.hooks.applyFilters("canHoverNode",e,l)}function n(e){return bu.hooks.applyFilters("canDragNode",e,l)}function s(e,t){var o=e.find("li").length,n=e.children("a");0===n.children(".title-count").children(".count").length&&n.children(".title-count").append('<span class="count"></span>'),n=n.find("> .title-count > .count").empty(),o?n.text("("+o+")"):n.text(""),t&&e.find("li").each(function(){s(h(this))})}function d(e){0===e.children("ul").length?e.attr("rel","page"):e.attr("rel","section"),a.showCounts&&(e=e.parent("ul").parent("div").attr("id")!=u.attr("id")?e.parents("li:last"):e,s(e,!0))}var r,l={},a=(c=c||{},bu.signals.register(l),l.config=h.extend({},_.settings,e||{}),l.data={treeConfig:{},rollback:void 0},l.config),i=l.data,u=l.$el=h(a.el),p=(a.themePath&&document.images&&(e=new Image,r=new Image,e.src=a.themePath+"/sprite.png",r.src=a.themePath+"/throbber.gif"),i.treeConfig={plugins:["themes","types","json_data","ui","dnd","crrm","bu"],core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},dnd:{drag_container:document},types:{types:{default:{max_children:-1,max_depth:-1,valid_children:"all",select_node:t,hover_node:o,start_drag:n},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:t,hover_node:o,start_drag:n},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:t,hover_node:o,start_drag:n},link:{max_children:0,max_depth:0,valid_children:"none",select_node:t,hover_node:o,start_drag:n}}},json_data:{ajax:{url:a.rpcUrl,type:"POST",data:function(e){e=-1===e?{ID:0}:c.nodeToPost(e);return{child_of:e.ID,post_types:a.postTypes,post_statuses:a.postStatuses,instance:a.instance,prefix:a.nodePrefix,include_links:a.includeLinks}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:function(e){var t=c.nodeToPost(e.o),o=-1===e.cr,t=!1===t.post_meta.excluded||t.post_type===a.linksPostType,n=!0;return o&&t&&!a.allowTop&&(n=!1),bu.hooks.applyFilters("moveAllowed",n,e,l)}}},bu:{lazy_load:a.lazyLoad}},a.showCounts&&(i.treeConfig.json_data.progressive_render=!1),a.initialTreeData&&(i.treeConfig.json_data.data=a.initialTreeData),i.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",i.treeConfig,u),l.initialize=function(){return u.jstree(i.treeConfig),l},l.openPost=function(e,t){e=c.getNodeForPost(e);if(t=t||h.noop,!e)return!1;u.jstree("open_node",e,t,!0)},l.selectPost=function(e,t){t=t||!0;e=c.getNodeForPost(e);t&&u.jstree("deselect_all"),u.jstree("select_node",e)},l.getSelectedPost=function(){var e=u.jstree("get_selected");return!!e.length&&c.nodeToPost(e)},l.deselectAll=function(){u.jstree("deselect_all")},l.getPost=function(e){e=c.getNodeForPost(e);return!!e&&c.nodeToPost(e)},l.getPosts=function(e){var o=[],n={},e=e?h.jstree._reference(u)._get_node("#"+e):u;return e.find("> ul > li").each(function(e,t){t=h(t),n=c.nodeToPost(t),t.find("> ul > li").length&&(n.children=l.getPosts(t.attr("id"))),o.push(n)}),o},l.showAll=function(){u.jstree("open_all")},l.hideAll=function(){u.jstree("close_all")},l.getPostLabel=function(e){e=c.getNodeForPost(e);return u.jstree("get_text",e)},l.setPostLabel=function(e,t){e=c.getNodeForPost(e);u.jstree("set_text",e,t)},l.insertPost=function(e,t){if(void 0===e)throw new TypeError("Post argument for insertPost must be defined!");var o,n,s,r,a;return e.post_parent=e.post_parent||0,e.menu_order=e.menu_order||1,e.post_parent?(r=c.getNodeForPost(e.post_parent),n=l.getPost(e.post_parent)):r=u,1==e.menu_order?(o=r.find("> ul > li").get(0),a="before"):0<=(s=e.menu_order-2)&&(o=r.find("> ul > li").get(s),a="after"),o||(o=r,a="inside"),s={which:o,position:a,callback:t||function(e){u.jstree("deselect_all"),u.jstree("select_node",e)}},e=bu.hooks.applyFilters("preInsertPost",e,n),r=c.postToNode(e),o=u.jstree("create_node",s.which,s.position,r,s.callback),e.ID||(e.ID=o.attr("id")),e},l.updatePost=function(e){var t,o=c.getNodeForPost(e);return!!o&&(t=c.nodeToPost(o),t=h.extend(!0,{},t,e),u.jstree("set_text",o,t.post_title),t.post_parent=parseInt(t.post_parent,10),t.menu_order=parseInt(t.menu_order,10),o.data("post",t),a.showStatuses&&o.find("li").addBack().each(function(){f(h(this))}),l.broadcast("postUpdated",[t]),t)},l.removePost=function(e){var t;e&&void 0===e?(t=u.jstree("get_selected"),e=c.nodeToPost(t)):t=c.getNodeForPost(e),u.jstree("remove",t)},l.getAncestors=function(e){e=c.getNodeForPost(e);return!1!==e&&u.jstree("get_path",e)},l.save=function(){i.rollback=u.jstree("get_rollback")},l.restore=function(){void 0!==i.rollback&&(i.rollback.d.ui.selected=h([]),h.jstree.rollback(i.rollback),i.rollback=u.jstree("get_rollback"))},l.lock=function(){u.jstree("lock")},l.unlock=function(){u.jstree("unlock")},c.nodeToPost=function(e){if(void 0===e)throw new TypeError("Invalid node!");var t=e.attr("id"),o=h.extend({},!0,e.data("post"));return-1===t.indexOf("post-new")&&(t=parseInt(c.stripNodePrefix(t),10)),o.ID=t,o.post_title=u.jstree("get_text",e),o.menu_order=e.index()+1,o.post_parent=parseInt(o.post_parent,10),o.originalParent=parseInt(o.originalParent,10),o.originalOrder=parseInt(o.originalOrder,10),o.post_meta=o.post_meta||{},bu.hooks.applyFilters("nodeToPost",o,e)},c.postToNode=function(e,t){if(void 0===e)throw new TypeError("Invalid post!");var t=t||!1,o=h.extend({},{post_title:"(no title)",post_content:"",post_status:"new",post_type:"page",post_parent:0,menu_order:1,post_meta:{},url:""},e),e={attr:{id:o.ID?a.nodePrefix+o.ID:"post-new-"+c.getNextPostID(),rel:c.getRelAttrForPost(e,t)},data:{title:o.post_title},metadata:{post:o}};return bu.hooks.applyFilters("postToNode",e,o)},c.getNodeForPost=function(e){var t;return void 0!==e&&(e&&"object"==typeof e?-1===(t=e.ID.toString()).indexOf("post-new")&&(t=a.nodePrefix+t):-1===(t=e.toString()).indexOf("post-new")&&(t=a.nodePrefix+t),!!(e=h.jstree._reference(u)._get_node("#"+t)).length&&e)},c.getNextPostID=function(){return h('[id*="post-new-"]').length},c.stripNodePrefix=function(e){return e.replace(a.nodePrefix,"")},c.getRelAttrForPost=function(e,t){t=t?"section":e.post_type==a.linksPostType?"link":"page";return t},function(e){var t,o,n,s;if(e=e||!1,t={excluded:{class:"excluded",label:a.statusBadgeExcluded,inherited:!1},protected:{class:"protected",label:a.statusBadgeProtected,inherited:!1}},s=o=bu.hooks.applyFilters("navStatusBadges",t),e)for(n in s={},o)o[n].hasOwnProperty("inherited")&&o[n].inherited&&(s[n]=o[n]);return s}),f=function(e){var t,o,n,s,r,a,i,d=e.children("a"),l=(0===d.children(".post-statuses").length&&d.append('<span class="post-statuses"></span>'),o=d.children(".post-statuses").empty(),t=c.nodeToPost(e),n=[],e);for(i in c.nodeToPost(l),p({inherited:!0}))l.parentsUntil("#"+u.attr("id"),"li").filter(function(){return h(this).data("post").post_meta[i]||h(this).data("inherited_"+i)}).length?l.data("inherited_"+i,!0):l.removeData("inherited_"+i);for(r in"publish"!=t.post_status&&n.push({class:t.post_status,label:t.post_status}),s=p())(t.post_meta[r]||e.data("inherited_"+r))&&n.push({class:s[r].class,label:s[r].label});for(a=0;a<n.length;a+=1)o.append('<span class="post_status '+n[a].class+'">'+n[a].label+"</span>")};u.on("loaded.jstree",function(e,t){var o=u.find("> ul > li:first-child"),o=18<=o.height()?o.height():32;u.jstree("data").data.core.li_height=o,l.broadcast("postsLoaded")}),u.on("reselect.jstree",function(e,t){l.broadcast("postsSelected")}),u.on("lazy_loaded.jstree",function(e,t){l.broadcast("lazyLoadComplete")}),u.on("load_node.jstree",function(e,t){-1!==t.rslt.obj&&(t=t.rslt.obj,a.showCounts&&s(t,!0))}),u.on("clean_node.jstree",function(e,t){t=t.rslt.obj;t&&-1!==t&&t.each(function(e,t){t=h(t);t.data("buNavExtrasAdded")||(a.showStatuses&&f(t),t.data("buNavExtrasAdded",!0))})}),u.on("before.jstree",function(e,t){var o;switch(t.func){case"select_node":case"hover_node":case"start_drag":if((o=t.inst._get_node(t.args[0]))&&o.hasClass("denied"))return!1}}),u.on("create_node.jstree",function(e,t){t=t.rslt.obj,t=c.nodeToPost(t);l.broadcast("postCreated",[t])}),u.on("select_node.jstree",function(e,t){t=c.nodeToPost(t.rslt.obj);l.broadcast("postSelected",[t])}),u.on("create.jstree",function(e,t){var o=t.rslt.obj,n=t.rslt.parent,t=t.rslt.position,o=c.nodeToPost(o),s=null;-1!==n&&(s=c.nodeToPost(n),d(n)),o.post_parent=s?s.ID:0,o.menu_order=t+1,l.broadcast("postInserted",[o])}),u.on("remove.jstree",function(e,t){var o,n=t.rslt.obj,s=c.nodeToPost(n),t=t.rslt.parent;-1!==t&&d(t),l.broadcast("postRemoved",[s]),n.find("li").each(function(){(o=c.nodeToPost(h(this)))&&l.broadcast("postRemoved",[o])})}),u.on("deselect_node.jstree",function(e,t){t=c.nodeToPost(t.rslt.obj);l.broadcast("postDeselected",[t])}),u.on("deselect_all.jstree",function(e,t){l.broadcast("postsDeselected")}),u.on("move_node.jstree",function(e,i){i.rslt.o.each(function(e,t){var t=h(t),o=c.nodeToPost(t),n=i.rslt.np,s=i.rslt.op,t=t.index()+1,r=0,a=0;u.attr("id")!==n.attr("id")&&(d(n),r=parseInt(c.stripNodePrefix(n.attr("id")),10)),u.attr("id")===s.attr("id")||n.is("#"+s.attr("id"))||(d(s),a=c.nodeToPost(s).ID),n=o.menu_order,o.post_parent=r,o.menu_order=t,l.updatePost(o),l.broadcast("postMoved",[o,a,n])})});return a.deselectOnDocumentClick&&h(document).on("click",function(e){var t;void 0!==u[0]&&(t=h.contains(u[0],e.target),e=h.contains(h("#vakata-contextmenu")[0],e.target),t||e||u.jstree("deselect_all"))}),l},navman:function(e,n){function s(e){e=n.nodeToPost(e),t.broadcast("editPost",[e])}function r(e){(e=n.nodeToPost(e)).url&&window.open(e.url)}function a(e){e=n.nodeToPost(e),t.removePost(e)}var t={},i=(n=n||{},(t=_.trees.base(e,n)).$el),e=t.data,d=t.config,l=(e.treeConfig.plugins.push("contextmenu"),e.treeConfig.contextmenu={show_at_node:!1,items:function(e){var t=n.nodeToPost(e),o={edit:{label:d.optionsEditLabel,action:s},view:{label:d.optionsViewLabel,action:r},remove:{label:d.optionsTrashLabel,action:a}};return t.url||delete o.view,t.post_type===d.linksPostType&&(o.remove.label=d.optionsDeleteLabel),bu.hooks.applyFilters("navmanOptionsMenuItems",o,e)}},i.on("loaded.jstree",function(e,t){i.off("contextmenu.jstree","a")}),i.bind("clean_node.jstree",function(e,t){t=t.rslt.obj;t&&-1!=t&&t.each(function(e,t){var o,n,t=h(t).children("a");t.children(".edit-options").length||(o=h('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>'+d.optionsLabel+"</button>"),(n=t.children(".post-statuses")).length?n.before(o):t.append(o))})}),null),c=(i.on("click",".edit-options",function(e){var t,o,n;e.preventDefault(),e.stopPropagation(),e=h(this).offset(),t=h(this).outerWidth(),n=h(this).outerHeight(),o=e.top,o+=n,n=e.left+t-180,e=h(this).closest("li"),i.jstree("deselect_all"),i.jstree("select_node",e),i.jstree("show_contextmenu",e,n,o),h(this).addClass("clicked"),l&&l.attr("id")!==e.attr("id")&&c(l),l=e}),h(document).on("context_hide.vakata",function(e,t){c(l)}),function(e){e&&e.find("> a > .edit-options").removeClass("clicked")});return i.addClass("bu-navman"),t},edit_post:function(e,o){o=o||{};function t(e,t){if(t.$el.is(n.$el.selector))return o.stripNodePrefix(e.attr("id"))==a.ID}var n=_.trees.base(e,o),s=n.data,r=h.extend(n.config,e||{}),e=n.$el,a=r.currentPost,i={},d=(i.dnd={drag_container:r.treeDragContainer},h.extend(!0,s.treeConfig,i),bu.hooks.addFilter("canSelectNode",t),bu.hooks.addFilter("canHoverNode",t),bu.hooks.addFilter("canDragNode",t),e.bind("loaded.jstree",function(e,t){var o;r.ancestors&&r.ancestors.length?(o=r.ancestors.reverse(),d(0,o)):l()}),function(t,o){var e=o[t];e?!1===n.openPost(e,function(){d(t+1,o)})&&n.insertPost(e,function(e){d(t+1,o)}):l()}),l=function(){o.getNodeForPost(a)?(n.selectPost(a),n.save()):n.insertPost(a,function(e){n.selectPost(a),n.save()})};return n.getCurrentPost=function(){var e=o.getNodeForPost(a);return!!e&&o.nodeToPost(e)},n.setCurrentPost=function(e){a=e},e.addClass("bu-edit-post"),n}}}(jQuery);