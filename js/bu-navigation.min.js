var bu=bu||{};bu.plugins=bu.plugins||{},bu.plugins.navigation={},function(a){"use strict";bu.signals=function(){var b={};return b.listenFor=function(a,b){var c=this._listeners;void 0===c[a]&&(c[a]=[]),c[a].push(b)},b.broadcast=function(a,b){var c,d=this._listeners;if(d[a])for(c=0;c<d[a].length;c+=1)d[a][c].apply(this,b||[])},{register:function(c){c._listeners={},a.extend(!0,c,b)}}}(),bu.hooks=function(){var a={};return{addFilter:function(b,c){return void 0===a[b]&&(a[b]=[]),a[b].push(c),this},applyFilters:function(b,c){if(void 0===a[b])return c;var d,e=Array.prototype.slice.apply(arguments),f=e.slice(1),g=c;for(d=0;d<a[b].length;d+=1)g=a[b][d].apply(this,f);return g}}}()}(jQuery),function(a){var b=bu.plugins.navigation;b.settings={lazyLoad:!0,showCounts:!0,showStatuses:!0,deselectOnDocumentClick:!0},a(document).ready(function(){a.browser.msie===!0&&7==parseInt(a.browser.version,10)&&a(document.body).addClass("ie7"),a.browser.msie===!0&&8==parseInt(a.browser.version,10)&&a(document.body).addClass("ie8"),a.browser.msie===!0&&9==parseInt(a.browser.version,10)&&a(document.body).addClass("ie9")}),b.tree=function(a,c){return"undefined"==typeof a&&(a="base"),b.trees[a](c).initialize()},b.trees={base:function(c,d){var e={};d=d||{},bu.signals.register(e),e.config=a.extend({},b.settings,c||{}),e.data={treeConfig:{},rollback:void 0};var f=e.config,g=e.data,h=e.$el=a(f.el);if(f.themePath&&document.images){var i=new Image,j=new Image;i.src=f.themePath+"/sprite.png",j.src=f.themePath+"/throbber.gif"}var k=function(a){var b,c,g,h;return b=d.nodeToPost(a.o),c=-1===a.cr,g=b.post_meta.excluded===!1||b.post_type===f.linksPostType,allowed=!0,c&&g&&!h&&!f.allowTop&&(allowed=!1),bu.hooks.applyFilters("moveAllowed",allowed,a,e)},l=function(a){return bu.hooks.applyFilters("canSelectNode",a,e)},m=function(a){return bu.hooks.applyFilters("canHoverNode",a,e)},n=function(a){return bu.hooks.applyFilters("canDragNode",a,e)};g.treeConfig={plugins:["themes","types","json_data","ui","dnd","crrm","bu"],core:{animation:0,html_titles:!0},ui:{selected_parent_close:!1},themes:{theme:"bu",load_css:!1},dnd:{drag_container:document},types:{types:{"default":{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:m,start_drag:n},page:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:m,start_drag:n},section:{max_children:-1,max_depth:-1,valid_children:"all",select_node:l,hover_node:m,start_drag:n},link:{max_children:0,max_depth:0,valid_children:"none",select_node:l,hover_node:m,start_drag:n}}},json_data:{ajax:{url:f.rpcUrl,type:"POST",data:function(a){var b;return b=-1===a?{ID:0}:d.nodeToPost(a),{child_of:b.ID,post_types:f.postTypes,post_statuses:f.postStatuses,instance:f.instance,prefix:f.nodePrefix,include_links:f.includeLinks}}},progressive_render:!0},crrm:{move:{default_position:"first",check_move:k}},bu:{lazy_load:f.lazyLoad}},f.showCounts&&(g.treeConfig.json_data.progressive_render=!1),f.initialTreeData&&(g.treeConfig.json_data.data=f.initialTreeData),g.treeConfig=bu.hooks.applyFilters("buNavTreeSettings",g.treeConfig,h),e.initialize=function(){return h.jstree(g.treeConfig),e},e.openPost=function(b,c){var e=d.getNodeForPost(b);return c=c||a.noop,e?void h.jstree("open_node",e,c,!0):!1},e.selectPost=function(a,b){b=b||!0;var c=d.getNodeForPost(a);b&&h.jstree("deselect_all"),h.jstree("select_node",c)},e.getSelectedPost=function(){var a=h.jstree("get_selected");return a.length?d.nodeToPost(a):!1},e.deselectAll=function(){h.jstree("deselect_all")},e.getPost=function(a){var b=d.getNodeForPost(a);return b?d.nodeToPost(b):!1},e.getPosts=function(b){var c,f=[],g={};return c=b?a.jstree._reference(h)._get_node("#"+b):h,c.find("> ul > li").each(function(b,c){c=a(c),g=d.nodeToPost(c),c.find("> ul > li").length&&(g.children=e.getPosts(c.attr("id"))),f.push(g)}),f},e.showAll=function(){h.jstree("open_all")},e.hideAll=function(){h.jstree("close_all")},e.getPostLabel=function(a){var b=d.getNodeForPost(a);return h.jstree("get_text",b)},e.setPostLabel=function(a,b){var c=d.getNodeForPost(a);h.jstree("set_text",c,b)},e.insertPost=function(a,b){if("undefined"==typeof a)throw new TypeError("Post argument for insertPost must be defined!");var c,f,g,i,j,k,l,m;return a.post_parent=a.post_parent||0,a.menu_order=a.menu_order||1,a.post_parent?(f=d.getNodeForPost(a.post_parent),i=e.getPost(a.post_parent)):f=h,1==a.menu_order?(g=f.find("> ul > li").get(0),m="before"):(j=a.menu_order-2,j>=0&&(g=f.find("> ul > li").get(j),m="after")),g||(g=f,m="inside"),k={which:g,position:m,callback:b||function(a){h.jstree("deselect_all"),h.jstree("select_node",a)}},a=bu.hooks.applyFilters("preInsertPost",a,i),l=d.postToNode(a),c=h.jstree("create_node",k.which,k.position,l,k.callback),a.ID||(a.ID=c.attr("id")),a},e.updatePost=function(b){var c,g,i=d.getNodeForPost(b);return i?(c=d.nodeToPost(i),g=a.extend(!0,{},c,b),h.jstree("set_text",i,g.post_title),g.post_parent=parseInt(g.post_parent,10),g.menu_order=parseInt(g.menu_order,10),i.data("post",g),f.showStatuses&&i.find("li").andSelf().each(function(){s(a(this))}),e.broadcast("postUpdated",[g]),g):!1},e.removePost=function(a){var b;a&&"undefined"==typeof a?(b=h.jstree("get_selected"),a=d.nodeToPost(b)):b=d.getNodeForPost(a),h.jstree("remove",b)},e.getAncestors=function(a){var b=d.getNodeForPost(a);return h.jstree("get_path",b)},e.save=function(){g.rollback=h.jstree("get_rollback")},e.restore=function(){"undefined"!=typeof g.rollback&&(g.rollback.d.ui.selected=a([]),a.jstree.rollback(g.rollback),g.rollback=h.jstree("get_rollback"))},e.lock=function(){h.jstree("lock")},e.unlock=function(){h.jstree("unlock")},d.nodeToPost=function(b){if("undefined"==typeof b)throw new TypeError("Invalid node!");var c,e;return c=b.attr("id"),e=a.extend({},!0,b.data("post")),-1===c.indexOf("post-new")&&(c=parseInt(d.stripNodePrefix(c),10)),e.ID=c,e.post_title=h.jstree("get_text",b),e.menu_order=b.index()+1,e.post_parent=parseInt(e.post_parent,10),e.originalParent=parseInt(e.originalParent,10),e.originalOrder=parseInt(e.originalOrder,10),e.post_meta=e.post_meta||{},bu.hooks.applyFilters("nodeToPost",e,b)},d.postToNode=function(b,c){if("undefined"==typeof b)throw new TypeError("Invalid post!");var e,g,h,i,c=c||!1;return e={post_title:"(no title)",post_content:"",post_status:"new",post_type:"page",post_parent:0,menu_order:1,post_meta:{},url:""},g=a.extend({},e,b),i=g.ID?f.nodePrefix+g.ID:"post-new-"+d.getNextPostID(),h={attr:{id:i,rel:d.getRelAttrForPost(b,c)},data:{title:g.post_title},metadata:{post:g}},bu.hooks.applyFilters("postToNode",h,g)},d.getNodeForPost=function(b){if("undefined"==typeof b)return!1;var c,d;return b&&"object"==typeof b?(c=b.ID.toString(),-1===c.indexOf("post-new")&&(c=f.nodePrefix+c)):(c=b.toString(),-1===c.indexOf("post-new")&&(c=f.nodePrefix+c)),d=a.jstree._reference(h)._get_node("#"+c),d.length?d:!1},d.getNextPostID=function(){var b=a('[id*="post-new-"]');return b.length},d.stripNodePrefix=function(a){return a.replace(f.nodePrefix,"")},d.getRelAttrForPost=function(a,b){var c;return c=b?"section":a.post_type==f.linksPostType?"link":"page"};var o=function(b,c){var d;d=b.find("li").length,p(b,d),c&&b.find("li").each(function(){o(a(this))})},p=function(a,b){var c,d=a.children("a");0===d.children(".title-count").children(".count").length&&d.children(".title-count").append('<span class="count"></span>'),c=d.find("> .title-count > .count").empty(),c.text(b?"("+b+")":"")},q=function(a){var b,c,d,e;if(a=a||!1,b={excluded:{"class":"excluded",label:f.statusBadgeExcluded,inherited:!1},"protected":{"class":"protected",label:f.statusBadgeProtected,inherited:!1}},c=bu.hooks.applyFilters("navStatusBadges",b),e=c,a){e={};for(d in c)c[d].hasOwnProperty("inherited")&&c[d].inherited&&(e[d]=c[d])}return e},r=function(b){var c,e,f,g;c=d.nodeToPost(b),e=q({inherited:!0});for(f in e)g=b.parentsUntil("#"+h.attr("id"),"li").filter(function(){return a(this).data("post").post_meta[f]||a(this).data("inherited_"+f)}).length,g?b.data("inherited_"+f,!0):b.removeData("inherited_"+f)},s=function(a){var b,c,e,f,g,h,i,j;b=a.children("a"),0===b.children(".post-statuses").length&&b.append('<span class="post-statuses"></span>'),e=b.children(".post-statuses").empty(),c=d.nodeToPost(a),f=[],r(a),"publish"!=c.post_status&&f.push({"class":c.post_status,label:c.post_status}),g=q();for(h in g)i=c.post_meta[h]||a.data("inherited_"+h),i&&f.push({"class":g[h]["class"],label:g[h].label});for(j=0;j<f.length;j+=1)e.append('<span class="post_status '+f[j]["class"]+'">'+f[j].label+"</span>")},t=function(a){var b;0===a.children("ul").length?a.attr("rel","page"):a.attr("rel","section"),f.showCounts&&(b=a.parent("ul").parent("div").attr("id")!=h.attr("id")?a.parents("li:last"):a,o(b,!0))};h.bind("loaded.jstree",function(){var a=h.find("> ul > li:first-child"),b=a.height()>=18?a.height():32;h.jstree("data").data.core.li_height=b,e.broadcast("postsLoaded")}),h.bind("reselect.jstree",function(){e.broadcast("postsSelected")}),h.bind("lazy_loaded.jstree",function(){e.broadcast("lazyLoadComplete")}),h.bind("load_node.jstree",function(a,b){if(-1!==b.rslt.obj){var c=b.rslt.obj;f.showCounts&&o(c,!0)}}),h.bind("clean_node.jstree",function(b,c){var d=c.rslt.obj;d&&-1!==d&&d.each(function(b,c){var d=a(c);d.data("buNavExtrasAdded")||(f.showStatuses&&s(d),d.data("buNavExtrasAdded",!0))})}),h.bind("before.jstree",function(a,b){var c;switch(b.func){case"select_node":case"hover_node":case"start_drag":if(c=b.inst._get_node(b.args[0]),c&&c.hasClass("denied"))return!1}}),h.bind("create_node.jstree",function(a,b){var c=b.rslt.obj,f=d.nodeToPost(c);e.broadcast("postCreated",[f])}),h.bind("select_node.jstree",function(a,b){var c=d.nodeToPost(b.rslt.obj);e.broadcast("postSelected",[c])}),h.bind("create.jstree",function(a,b){var c=b.rslt.obj,f=b.rslt.parent,g=b.rslt.position,h=d.nodeToPost(c),i=null;-1!==f&&(i=d.nodeToPost(f),t(f)),h.post_parent=i?i.ID:0,h.menu_order=g+1,e.broadcast("postInserted",[h])}),h.bind("remove.jstree",function(b,c){var f,g=c.rslt.obj,h=d.nodeToPost(g),i=c.rslt.parent;-1!==i&&t(i),e.broadcast("postRemoved",[h]),g.find("li").each(function(){f=d.nodeToPost(a(this)),f&&e.broadcast("postRemoved",[f])})}),h.bind("deselect_node.jstree",function(a,b){var c=d.nodeToPost(b.rslt.obj);e.broadcast("postDeselected",[c])}),h.bind("deselect_all.jstree",function(){e.broadcast("postsDeselected")}),h.bind("move_node.jstree",function(b,c){var f=c.rslt.o;f.each(function(b,f){var g,i=a(f),j=d.nodeToPost(i),k=c.rslt.np,l=c.rslt.op,m=i.index()+1,n=0,o=0,p=1;h.attr("id")!==k.attr("id")&&(t(k),n=parseInt(d.stripNodePrefix(k.attr("id")),10)),h.attr("id")===l.attr("id")||k.is("#"+l.attr("id"))||(t(l),g=d.nodeToPost(l),o=g.ID),p=j.menu_order,j.post_parent=n,j.menu_order=m,e.updatePost(j),e.broadcast("postMoved",[j,o,p])})});var u=function(b){if("undefined"!=typeof h[0]){var c=a.contains(h[0],b.target),d=a.contains(a("#vakata-contextmenu")[0],b.target);c||d||h.jstree("deselect_all")}};return f.deselectOnDocumentClick&&a(document).bind("click",u),e},navman:function(c,d){var e={};d=d||{},e=b.trees.base(c,d);var f=e.$el,g=e.data,h=e.config,i=function(a){var b=d.nodeToPost(a),c={edit:{label:h.optionsEditLabel,action:j},view:{label:h.optionsViewLabel,action:k},remove:{label:h.optionsTrashLabel,action:l}};return b.url||delete c.view,b.post_type===h.linksPostType&&(c.remove.label=h.optionsDeleteLabel),bu.hooks.applyFilters("navmanOptionsMenuItems",c,a)},j=function(a){var b=d.nodeToPost(a);e.broadcast("editPost",[b])},k=function(a){var b=d.nodeToPost(a);b.url&&window.open(b.url)},l=function(a){var b=d.nodeToPost(a);e.removePost(b)};g.treeConfig.plugins.push("contextmenu"),g.treeConfig.contextmenu={show_at_node:!1,items:i},f.bind("loaded.jstree",function(){f.undelegate("a","contextmenu.jstree")}),f.bind("clean_node.jstree",function(b,c){var d=c.rslt.obj;d&&-1!=d&&d.each(function(b,c){var d=a(c),e=d.children("a");if(!e.children(".edit-options").length){var f=a('<button class="edit-options"><ins class="jstree-icon">&#160;</ins>'+h.optionsLabel+"</button>"),g=e.children(".post-statuses");g.length?g.before(f):e.append(f)}})});var m=null;f.delegate(".edit-options","click",function(b){b.preventDefault(),b.stopPropagation();var c,d,e,g,h,i;c=a(this).offset(),d=a(this).outerWidth(),e=a(this).outerHeight(),g=c.top,h=c.left,g+=e,h=h+d-180,i=a(this).closest("li"),f.jstree("deselect_all"),f.jstree("select_node",i),f.jstree("show_contextmenu",i,h,g),a(this).addClass("clicked"),m&&m.attr("id")!=i.attr("id")&&n(m),m=i}),a(document).bind("context_hide.vakata",function(){n(m)});var n=function(a){a&&a.find("> a > .edit-options").removeClass("clicked")};return f.addClass("bu-navman"),e},edit_post:function(c,d){d=d||{};var e=b.trees.base(c,d),f=e.data,g=a.extend(e.config,c||{}),h=e.$el,i=g.currentPost,j={};j.dnd={drag_container:g.treeDragContainer},a.extend(!0,f.treeConfig,j);var k=function(a,b){if(b.$el.is(e.$el.selector)){var c=d.stripNodePrefix(a.attr("id"));return c==i.ID}};bu.hooks.addFilter("canSelectNode",k),bu.hooks.addFilter("canHoverNode",k),bu.hooks.addFilter("canDragNode",k),h.bind("loaded.jstree",function(){var a;g.ancestors&&g.ancestors.length?(a=g.ancestors.reverse(),l(0,a)):m()});var l=function(a,b){var c=b[a];c?e.openPost(c,function(){l(a+1,b)})===!1&&e.insertPost(c,function(){l(a+1,b)}):m()},m=function(){var a=d.getNodeForPost(i);a?(e.selectPost(i),e.save()):e.insertPost(i,function(){e.selectPost(i),e.save()})};return e.getCurrentPost=function(){var a,b;return a=d.getNodeForPost(i),a?b=d.nodeToPost(a):!1},e.setCurrentPost=function(a){i=a},h.addClass("bu-edit-post"),e}}}(jQuery);