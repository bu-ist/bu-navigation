if("undefined"==typeof bu||void 0===bu.plugins.navigation||void 0===bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");!function(o){"use strict";var e,n,l;bu.plugins.navigation.views=bu.plugins.navigation.views||{},e=bu.plugins.navigation.views.Navman={el:"#nav-tree-container",ui:{form:"#navman_form",noticesContainer:"#navman-notices",movesField:"#navman-moves",insertsField:"#navman-inserts",updatesField:"#navman-updates",deletionsField:"#navman-deletions",expandAllBtn:"#navman_expand_all",collapseAllBtn:"#navman_collapse_all",saveBtn:"#bu_navman_save"},data:{dirty:!1,deletions:[],insertions:{},updates:{},moves:{}},initialize:function(t){var i=this.settings=bu_navman_settings;i.el=this.el,l=bu.plugins.navigation.tree("navman",i),n.initialize({allowTop:!!i.allowTop,isSectionEditor:!!i.isSectionEditor}),l.listenFor("editPost",this.editPost.bind(this)),l.listenFor("postRemoved",this.postRemoved.bind(this)),l.listenFor("postMoved",this.postMoved.bind(this)),n.listenFor("linkInserted",this.linkInserted.bind(this)),n.listenFor("linkUpdated",this.linkUpdated.bind(this)),o(this.ui.form).on("submit",this.save.bind(this)),o(this.ui.expandAllBtn).on("click",this.expandAll),o(this.ui.collapseAllBtn).on("click",this.collapseAll)},expandAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),l.showAll()},collapseAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),l.hideAll()},editPost:function(t){bu_navman_settings.linksPostType===t.post_type?n.edit(t):(t="post.php?action=edit&post="+t.ID,window.location=t)},linkInserted:function(t){this.data.insertions[t.ID]=t,this.data.dirty=!0},linkUpdated:function(t){"new"===t.post_status?this.data.insertions[t.ID]=t:this.data.updates[t.ID]=t,this.data.dirty=!0},postRemoved:function(t){t=t.ID;t&&(void 0!==this.data.insertions[t]?delete this.data.insertions[t]:(void 0!==this.data.updates[t]?delete this.data.updates[t]:void 0!==this.data.moves[t]&&delete this.data.moves[t],this.data.deletions.push(t),this.data.dirty=!0))},postMoved:function(t){"new"!==t.post_status&&(this.data.moves[t.ID]=t,this.data.dirty=!0)},save:function(t){var e,i=this.data.deletions,n={},s={},a={},i=(o.each(this.data.insertions,function(t,i){(e=l.getPost(t))&&(a[e.ID]=e)}),o.each(this.data.updates,function(t,i){(e=l.getPost(t))&&(s[e.ID]=e)}),o.each(this.data.moves,function(t,i){(e=l.getPost(t))&&(n[e.ID]={ID:e.ID,post_status:e.post_status,post_type:e.post_type,post_parent:e.post_parent,menu_order:e.menu_order})}),o(this.ui.deletionsField).prop("value",JSON.stringify(i)),o(this.ui.insertsField).prop("value",JSON.stringify(a)),o(this.ui.updatesField).prop("value",JSON.stringify(s)),o(this.ui.movesField).prop("value",JSON.stringify(n)),o("<span>"+bu_navman_settings.saveNotice+"</span>"));o(this.ui.saveBtn).prev("img").css("visibility","visible"),this.notice(i.html(),"message"),l.lock(),this.data.dirty=!1},notice:function(t,i,e){e=e||!0;var n=o(this.ui.noticesContainer);e&&n.empty(),n.append('<div class="'+("message"===i?"updated fade":"error")+' below-h2"><p>'+t+"</p></div>")}},n=bu.plugins.navigation.views.Linkman={el:"#navman-link-editor",ui:{form:"#navman_editlink_form",addBtn:"#navman_add_link",urlField:"#editlink_address",labelField:"#editlink_label",targetNewField:"#editlink_target_new",targetSameField:"#editlink_target_same"},data:{currentLink:null,allowTop:!0,isSectionEditor:!1},initialize:function(t){o.extend(!0,this.data,t=t||{}),bu.signals.register(this),this.$el=o(this.el),this.$form=o(this.ui.form);t={};t[bu_navman_settings.confirmLinkBtn]=this.save.bind(this),t[bu_navman_settings.cancelLinkBtn]=this.cancel.bind(this),this.$el.dialog({autoOpen:!1,buttons:t,minWidth:400,width:500,modal:!0,resizable:!1}),o(document.body).on("click",".ui-widget-overlay, .ui-widget",this.stopPropagation),o(this.ui.addBtn).on("click",this.add.bind(this)),l.listenFor("postSelected",this.onPostSelected.bind(this)),l.listenFor("postDeselected",this.onPostDeselected.bind(this)),l.listenFor("postsDeselected",this.onPostDeselected.bind(this))},add:function(t){t.preventDefault(),t.stopPropagation();var i="";o(t.currentTarget).parent("li").hasClass("disabled")?(t=l.getSelectedPost(),i=bu_navman_settings.noLinksNotice,t&&bu_navman_settings.linksPostType===t.post_type?i=bu_navman_settings.noChildLinkNotice+"\n\n"+bu_navman_settings.createLinkNotice:e.settings.isSectionEditor?i=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice:e.settings.allowTop||(i=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice+"\n\n"+bu_navman_settings.allowTopNotice),alert(i)):(this.data.currentLink={post_status:"new",post_type:bu_navman_settings.linksPostType,post_meta:{}},this.$el.dialog("option","title",bu_navman_settings.addLinkDialogTitle).dialog("open"))},edit:function(t){o(this.ui.urlField).prop("value",t.post_content),o(this.ui.labelField).prop("value",t.post_title),("new"===t.post_meta.bu_link_target?o(this.ui.targetNewField):o(this.ui.targetSameField)).prop("checked",!0),this.data.currentLink=t,this.$el.dialog("option","title",bu_navman_settings.editLinkDialogTitle).dialog("open")},save:function(t){var i,e;t.preventDefault(),t.stopPropagation(),this.$form.valid()&&((t=this.data.currentLink).post_content=o(this.ui.urlField).prop("value"),t.post_title=o(this.ui.labelField).prop("value"),t.url=t.post_content,t.post_meta.bu_link_target=o("input[name='editlink_target']:checked").prop("value"),e=l.getSelectedPost(),t.post_parent=e?e.ID:0,t.menu_order=1,"new"!==t.post_status||t.ID?(i=l.updatePost(t),this.broadcast("linkUpdated",[i])):(i=l.insertPost(t),this.broadcast("linkInserted",[i])),this.clear(),this.$el.dialog("close"))},cancel:function(t){t.preventDefault(),t.stopPropagation(),this.$el.dialog("close"),this.clear()},clear:function(){o(this.ui.urlField).prop("value",""),o(this.ui.labelField).prop("value",""),o(this.ui.targetSameField).prop("checked",!0),o(this.ui.targetNewField).prop("checked",!1),this.data.currentLink=null},onPostSelected:function(t){var i=!0;t.post_type==bu_navman_settings.linksPostType&&(i=!1),(i=bu.hooks.applyFilters("navmanCanAddLink",i,t,l))?o(this.ui.addBtn).parent("li").removeClass("disabled"):o(this.ui.addBtn).parent("li").addClass("disabled")},onPostDeselected:function(){var t=this.data.allowTop;bu.hooks.applyFilters("navmanCanAddLink",t)?o(this.ui.addBtn).parent("li").removeClass("disabled"):o(this.ui.addBtn).parent("li").addClass("disabled")},stopPropagation:function(t){t.stopPropagation()}},window.onbeforeunload=function(){if(e.data.dirty)return bu_navman_settings.unloadWarning}}(jQuery),jQuery(document).ready(function(t){"use strict";bu.plugins.navigation.views.Navman.initialize()});