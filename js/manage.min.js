if("undefined"==typeof bu||"undefined"==typeof bu.plugins.navigation||"undefined"==typeof bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");!function(a){"use strict";bu.plugins.navigation.views=bu.plugins.navigation.views||{};var b,c,d;b=bu.plugins.navigation.views.Navman={el:"#nav-tree-container",ui:{form:"#navman_form",noticesContainer:"#navman-notices",movesField:"#navman-moves",insertsField:"#navman-inserts",updatesField:"#navman-updates",deletionsField:"#navman-deletions",expandAllBtn:"#navman_expand_all",collapseAllBtn:"#navman_collapse_all",saveBtn:"#bu_navman_save"},data:{dirty:!1,deletions:[],insertions:{},updates:{},moves:{}},initialize:function(){var b=this.settings=bu_navman_settings;b.el=this.el,d=bu.plugins.navigation.tree("navman",b),c.initialize({allowTop:!!b.allowTop,isSectionEditor:!!b.isSectionEditor}),d.listenFor("editPost",a.proxy(this.editPost,this)),d.listenFor("postRemoved",a.proxy(this.postRemoved,this)),d.listenFor("postMoved",a.proxy(this.postMoved,this)),c.listenFor("linkInserted",a.proxy(this.linkInserted,this)),c.listenFor("linkUpdated",a.proxy(this.linkUpdated,this)),a(this.ui.form).bind("submit",a.proxy(this.save,this)),a(this.ui.expandAllBtn).bind("click",this.expandAll),a(this.ui.collapseAllBtn).bind("click",this.collapseAll)},expandAll:function(a){a.preventDefault(),a.stopImmediatePropagation(),d.showAll()},collapseAll:function(a){a.preventDefault(),a.stopImmediatePropagation(),d.hideAll()},editPost:function(a){if(bu_navman_settings.linksPostType===a.post_type)c.edit(a);else{var b="post.php?action=edit&post="+a.ID;window.location=b}},linkInserted:function(a){this.data.insertions[a.ID]=a,this.data.dirty=!0},linkUpdated:function(a){"new"===a.post_status?this.data.insertions[a.ID]=a:this.data.updates[a.ID]=a,this.data.dirty=!0},postRemoved:function(a){var b=a.ID;b&&("undefined"!=typeof this.data.insertions[b]?delete this.data.insertions[b]:"undefined"!=typeof this.data.updates[b]?(delete this.data.updates[b],this.data.deletions.push(b),this.data.dirty=!0):"undefined"!=typeof this.data.moves[b]?(delete this.data.moves[b],this.data.deletions.push(b),this.data.dirty=!0):(this.data.deletions.push(b),this.data.dirty=!0))},postMoved:function(a){"new"!==a.post_status&&(this.data.moves[a.ID]=a,this.data.dirty=!0)},save:function(){var b,c=this.data.deletions,e={},f={},g={};a.each(this.data.insertions,function(a){b=d.getPost(a),b&&(g[b.ID]=b)}),a.each(this.data.updates,function(a){b=d.getPost(a),b&&(f[b.ID]=b)}),a.each(this.data.moves,function(a){b=d.getPost(a),b&&(e[b.ID]={ID:b.ID,post_status:b.post_status,post_type:b.post_type,post_parent:b.post_parent,menu_order:b.menu_order})}),a(this.ui.deletionsField).attr("value",JSON.stringify(c)),a(this.ui.insertsField).attr("value",JSON.stringify(g)),a(this.ui.updatesField).attr("value",JSON.stringify(f)),a(this.ui.movesField).attr("value",JSON.stringify(e));var h=a("<span>"+bu_navman_settings.saveNotice+"</span>");a(this.ui.saveBtn).prev("img").css("visibility","visible"),this.notice(h.html(),"message"),d.lock(),this.data.dirty=!1},notice:function(b,c,d){d=d||!0;var e=a(this.ui.noticesContainer),f="";d&&e.empty(),f="message"===c?"updated fade":"error",e.append('<div class="'+f+' below-h2"><p>'+b+"</p></div>")}},c=bu.plugins.navigation.views.Linkman={el:"#navman-link-editor",ui:{form:"#navman_editlink_form",addBtn:"#navman_add_link",urlField:"#editlink_address",labelField:"#editlink_label",targetNewField:"#editlink_target_new",targetSameField:"#editlink_target_same"},data:{currentLink:null,allowTop:!0,isSectionEditor:!1},initialize:function(b){b=b||{},a.extend(!0,this.data,b),bu.signals.register(this),this.$el=a(this.el),this.$form=a(this.ui.form);var c={};c[bu_navman_settings.confirmLinkBtn]=a.proxy(this.save,this),c[bu_navman_settings.cancelLinkBtn]=a.proxy(this.cancel,this),this.$el.dialog({autoOpen:!1,buttons:c,minWidth:400,width:500,modal:!0,resizable:!1}),a(document.body).delegate(".ui-widget-overlay, .ui-widget","click",this.stopPropagation),a(this.ui.addBtn).bind("click",a.proxy(this.add,this)),d.listenFor("postSelected",a.proxy(this.onPostSelected,this)),d.listenFor("postDeselected",a.proxy(this.onPostDeselected,this)),d.listenFor("postsDeselected",a.proxy(this.onPostDeselected,this))},add:function(c){c.preventDefault(),c.stopPropagation();var e,f="";a(c.currentTarget).parent("li").hasClass("disabled")?(e=d.getSelectedPost(),f=bu_navman_settings.noLinksNotice,e&&bu_navman_settings.linksPostType===e.post_type?f=bu_navman_settings.noChildLinkNotice+"\n\n"+bu_navman_settings.createLinkNotice:b.settings.isSectionEditor?f=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice:b.settings.allowTop||(f=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice+"\n\n"+bu_navman_settings.allowTopNotice),alert(f)):(this.data.currentLink={post_status:"new",post_type:bu_navman_settings.linksPostType,post_meta:{}},this.$el.dialog("option","title",bu_navman_settings.addLinkDialogTitle).dialog("open"))},edit:function(b){a(this.ui.urlField).attr("value",b.post_content),a(this.ui.labelField).attr("value",b.post_title),"new"===b.post_meta.bu_link_target?a(this.ui.targetNewField).attr("checked","checked"):a(this.ui.targetSameField).attr("checked","checked"),this.data.currentLink=b,this.$el.dialog("option","title",bu_navman_settings.editLinkDialogTitle).dialog("open")},save:function(b){if(b.preventDefault(),b.stopPropagation(),this.$form.valid()){var c,e,f=this.data.currentLink;f.post_content=a(this.ui.urlField).attr("value"),f.post_title=a(this.ui.labelField).attr("value"),f.url=f.post_content,f.post_meta.bu_link_target=a("input[name='editlink_target']:checked").attr("value"),e=d.getSelectedPost(),e?(f.post_parent=e.ID,f.menu_order=1):(f.post_parent=0,f.menu_order=1),"new"!==f.post_status||f.ID?(c=d.updatePost(f),this.broadcast("linkUpdated",[c])):(c=d.insertPost(f),this.broadcast("linkInserted",[c])),this.clear(),this.$el.dialog("close")}},cancel:function(a){a.preventDefault(),a.stopPropagation(),this.$el.dialog("close"),this.clear()},clear:function(){a(this.ui.urlField).attr("value",""),a(this.ui.labelField).attr("value",""),a(this.ui.targetSameField).attr("checked","checked"),a(this.ui.targetNewField).removeAttr("checked"),this.data.currentLink=null},onPostSelected:function(b){var c=!0;b.post_type==bu_navman_settings.linksPostType&&(c=!1),c=bu.hooks.applyFilters("navmanCanAddLink",c,b,d),c?a(this.ui.addBtn).parent("li").removeClass("disabled"):a(this.ui.addBtn).parent("li").addClass("disabled")},onPostDeselected:function(){var b=this.data.allowTop;b=bu.hooks.applyFilters("navmanCanAddLink",b),b?a(this.ui.addBtn).parent("li").removeClass("disabled"):a(this.ui.addBtn).parent("li").addClass("disabled")},stopPropagation:function(a){a.stopPropagation()}},window.onbeforeunload=function(){return b.data.dirty?bu_navman_settings.unloadWarning:void 0}}(jQuery),jQuery(document).ready(function(){"use strict";bu.plugins.navigation.views.Navman.initialize()});