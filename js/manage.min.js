if("undefined"==typeof bu||void 0===bu.plugins.navigation||void 0===bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");!function(t){"use strict";var i,e,n;bu.plugins.navigation.views=bu.plugins.navigation.views||{},i=bu.plugins.navigation.views.Navman={el:"#nav-tree-container",ui:{form:"#navman_form",noticesContainer:"#navman-notices",movesField:"#navman-moves",insertsField:"#navman-inserts",updatesField:"#navman-updates",deletionsField:"#navman-deletions",expandAllBtn:"#navman_expand_all",collapseAllBtn:"#navman_collapse_all",saveBtn:"#bu_navman_save"},data:{dirty:!1,deletions:[],insertions:{},updates:{},moves:{}},initialize:function(i){var s=this.settings=bu_navman_settings;s.el=this.el,n=bu.plugins.navigation.tree("navman",s),e.initialize({allowTop:!!s.allowTop,isSectionEditor:!!s.isSectionEditor}),n.listenFor("editPost",this.editPost.bind(this)),n.listenFor("postRemoved",this.postRemoved.bind(this)),n.listenFor("postMoved",this.postMoved.bind(this)),e.listenFor("linkInserted",this.linkInserted.bind(this)),e.listenFor("linkUpdated",this.linkUpdated.bind(this)),t(this.ui.form).on("submit",this.save.bind(this)),t(this.ui.expandAllBtn).on("click",this.expandAll),t(this.ui.collapseAllBtn).on("click",this.collapseAll)},expandAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),n.showAll()},collapseAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),n.hideAll()},editPost:function(t){if(bu_navman_settings.linksPostType===t.post_type)e.edit(t);else{var i="post.php?action=edit&post="+t.ID;window.location=i}},linkInserted:function(t){this.data.insertions[t.ID]=t,this.data.dirty=!0},linkUpdated:function(t){"new"===t.post_status?this.data.insertions[t.ID]=t:this.data.updates[t.ID]=t,this.data.dirty=!0},postRemoved:function(t){var i=t.ID;i&&(void 0!==this.data.insertions[i]?delete this.data.insertions[i]:void 0!==this.data.updates[i]?(delete this.data.updates[i],this.data.deletions.push(i),this.data.dirty=!0):void 0!==this.data.moves[i]?(delete this.data.moves[i],this.data.deletions.push(i),this.data.dirty=!0):(this.data.deletions.push(i),this.data.dirty=!0))},postMoved:function(t){"new"!==t.post_status&&(this.data.moves[t.ID]=t,this.data.dirty=!0)},save:function(i){var e,s=this.data.deletions,a={},o={},l={};t.each(this.data.insertions,(function(t,i){(e=n.getPost(t))&&(l[e.ID]=e)})),t.each(this.data.updates,(function(t,i){(e=n.getPost(t))&&(o[e.ID]=e)})),t.each(this.data.moves,(function(t,i){(e=n.getPost(t))&&(a[e.ID]={ID:e.ID,post_status:e.post_status,post_type:e.post_type,post_parent:e.post_parent,menu_order:e.menu_order})})),t(this.ui.deletionsField).attr("value",JSON.stringify(s)),t(this.ui.insertsField).attr("value",JSON.stringify(l)),t(this.ui.updatesField).attr("value",JSON.stringify(o)),t(this.ui.movesField).attr("value",JSON.stringify(a));var d=t("<span>"+bu_navman_settings.saveNotice+"</span>");t(this.ui.saveBtn).prev("img").css("visibility","visible"),this.notice(d.html(),"message"),n.lock(),this.data.dirty=!1},notice:function(i,e,n){n=n||!0;var s,a=t(this.ui.noticesContainer);n&&a.empty(),s="message"===e?"updated fade":"error",a.append('<div class="'+s+' below-h2"><p>'+i+"</p></div>")}},e=bu.plugins.navigation.views.Linkman={el:"#navman-link-editor",ui:{form:"#navman_editlink_form",addBtn:"#navman_add_link",urlField:"#editlink_address",labelField:"#editlink_label",targetNewField:"#editlink_target_new",targetSameField:"#editlink_target_same"},data:{currentLink:null,allowTop:!0,isSectionEditor:!1},initialize:function(i){i=i||{},t.extend(!0,this.data,i),bu.signals.register(this),this.$el=t(this.el),this.$form=t(this.ui.form);var e={};e[bu_navman_settings.confirmLinkBtn]=this.save.bind(this),e[bu_navman_settings.cancelLinkBtn]=this.cancel.bind(this),this.$el.dialog({autoOpen:!1,buttons:e,minWidth:400,width:500,modal:!0,resizable:!1}),t(document.body).on("click",".ui-widget-overlay, .ui-widget",this.stopPropagation),t(this.ui.addBtn).on("click",this.add.bind(this)),n.listenFor("postSelected",this.onPostSelected.bind(this)),n.listenFor("postDeselected",this.onPostDeselected.bind(this)),n.listenFor("postsDeselected",this.onPostDeselected.bind(this))},add:function(e){e.preventDefault(),e.stopPropagation();var s,a="";t(e.currentTarget).parent("li").hasClass("disabled")?(s=n.getSelectedPost(),a=bu_navman_settings.noLinksNotice,s&&bu_navman_settings.linksPostType===s.post_type?a=bu_navman_settings.noChildLinkNotice+"\n\n"+bu_navman_settings.createLinkNotice:i.settings.isSectionEditor?a=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice:i.settings.allowTop||(a=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice+"\n\n"+bu_navman_settings.allowTopNotice),alert(a)):(this.data.currentLink={post_status:"new",post_type:bu_navman_settings.linksPostType,post_meta:{}},this.$el.dialog("option","title",bu_navman_settings.addLinkDialogTitle).dialog("open"))},edit:function(i){t(this.ui.urlField).prop("value",i.post_content),t(this.ui.labelField).prop("value",i.post_title),"new"===i.post_meta.bu_link_target?t(this.ui.targetNewField).prop("checked",!0):t(this.ui.targetSameField).prop("checked",!0),this.data.currentLink=i,this.$el.dialog("option","title",bu_navman_settings.editLinkDialogTitle).dialog("open")},save:function(i){if(i.preventDefault(),i.stopPropagation(),this.$form.valid()){var e,s,a=this.data.currentLink;a.post_content=t(this.ui.urlField).prop("value"),a.post_title=t(this.ui.labelField).prop("value"),a.url=a.post_content,a.post_meta.bu_link_target=t("input[name='editlink_target']:checked").prop("value"),(s=n.getSelectedPost())?(a.post_parent=s.ID,a.menu_order=1):(a.post_parent=0,a.menu_order=1),"new"!==a.post_status||a.ID?(e=n.updatePost(a),this.broadcast("linkUpdated",[e])):(e=n.insertPost(a),this.broadcast("linkInserted",[e])),this.clear(),this.$el.dialog("close")}},cancel:function(t){t.preventDefault(),t.stopPropagation(),this.$el.dialog("close"),this.clear()},clear:function(){t(this.ui.urlField).attr("value",""),t(this.ui.labelField).attr("value",""),t(this.ui.targetSameField).prop("checked",!0),t(this.ui.targetNewField).prop("checked",!1),this.data.currentLink=null},onPostSelected:function(i){var e=!0;i.post_type==bu_navman_settings.linksPostType&&(e=!1),(e=bu.hooks.applyFilters("navmanCanAddLink",e,i,n))?t(this.ui.addBtn).parent("li").removeClass("disabled"):t(this.ui.addBtn).parent("li").addClass("disabled")},onPostDeselected:function(){var i=this.data.allowTop;(i=bu.hooks.applyFilters("navmanCanAddLink",i))?t(this.ui.addBtn).parent("li").removeClass("disabled"):t(this.ui.addBtn).parent("li").addClass("disabled")},stopPropagation:function(t){t.stopPropagation()}},window.onbeforeunload=function(){if(i.data.dirty)return bu_navman_settings.unloadWarning}}(jQuery),jQuery(document).ready((function(t){"use strict";bu.plugins.navigation.views.Navman.initialize()}));