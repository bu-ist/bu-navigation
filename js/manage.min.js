if("undefined"==typeof bu||void 0===bu.plugins.navigation||void 0===bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");!function(l){"use strict";var n,e,d;bu.plugins.navigation.views=bu.plugins.navigation.views||{},n=bu.plugins.navigation.views.Navman={el:"#nav-tree-container",ui:{form:"#navman_form",noticesContainer:"#navman-notices",movesField:"#navman-moves",insertsField:"#navman-inserts",updatesField:"#navman-updates",deletionsField:"#navman-deletions",expandAllBtn:"#navman_expand_all",collapseAllBtn:"#navman_collapse_all",saveBtn:"#bu_navman_save"},data:{dirty:!1,deletions:[],insertions:{},updates:{},moves:{}},initialize:function(t){var i=this.settings=bu_navman_settings;i.el=this.el,d=bu.plugins.navigation.tree("navman",i),e.initialize({allowTop:!!i.allowTop,isSectionEditor:!!i.isSectionEditor}),d.listenFor("editPost",this.editPost.bind(this)),d.listenFor("postRemoved",this.postRemoved.bind(this)),d.listenFor("postMoved",this.postMoved.bind(this)),e.listenFor("linkInserted",this.linkInserted.bind(this)),e.listenFor("linkUpdated",this.linkUpdated.bind(this)),l(this.ui.form).on("submit",this.save.bind(this)),l(this.ui.expandAllBtn).on("click",this.expandAll),l(this.ui.collapseAllBtn).on("click",this.collapseAll)},expandAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),d.showAll()},collapseAll:function(t){t.preventDefault(),t.stopImmediatePropagation(),d.hideAll()},editPost:function(t){var i;bu_navman_settings.linksPostType===t.post_type?e.edit(t):(i="post.php?action=edit&post="+t.ID,window.location=i)},linkInserted:function(t){this.data.insertions[t.ID]=t,this.data.dirty=!0},linkUpdated:function(t){"new"===t.post_status?this.data.insertions[t.ID]=t:this.data.updates[t.ID]=t,this.data.dirty=!0},postRemoved:function(t){var i=t.ID;i&&(void 0!==this.data.insertions[i]?delete this.data.insertions[i]:(void 0!==this.data.updates[i]?delete this.data.updates[i]:void 0!==this.data.moves[i]&&delete this.data.moves[i],this.data.deletions.push(i),this.data.dirty=!0))},postMoved:function(t){"new"!==t.post_status&&(this.data.moves[t.ID]=t,this.data.dirty=!0)},save:function(t){var e,i=this.data.deletions,n={},s={},a={};l.each(this.data.insertions,function(t,i){(e=d.getPost(t))&&(a[e.ID]=e)}),l.each(this.data.updates,function(t,i){(e=d.getPost(t))&&(s[e.ID]=e)}),l.each(this.data.moves,function(t,i){(e=d.getPost(t))&&(n[e.ID]={ID:e.ID,post_status:e.post_status,post_type:e.post_type,post_parent:e.post_parent,menu_order:e.menu_order})}),l(this.ui.deletionsField).attr("value",JSON.stringify(i)),l(this.ui.insertsField).attr("value",JSON.stringify(a)),l(this.ui.updatesField).attr("value",JSON.stringify(s)),l(this.ui.movesField).attr("value",JSON.stringify(n));var o=l("<span>"+bu_navman_settings.saveNotice+"</span>");l(this.ui.saveBtn).prev("img").css("visibility","visible"),this.notice(o.html(),"message"),d.lock(),this.data.dirty=!1},notice:function(t,i,e){e=e||!0;var n,s=l(this.ui.noticesContainer);e&&s.empty(),n="message"===i?"updated fade":"error",s.append('<div class="'+n+' below-h2"><p>'+t+"</p></div>")}},e=bu.plugins.navigation.views.Linkman={el:"#navman-link-editor",ui:{form:"#navman_editlink_form",addBtn:"#navman_add_link",urlField:"#editlink_address",labelField:"#editlink_label",targetNewField:"#editlink_target_new",targetSameField:"#editlink_target_same"},data:{currentLink:null,allowTop:!0,isSectionEditor:!1},initialize:function(t){t=t||{},l.extend(!0,this.data,t),bu.signals.register(this),this.$el=l(this.el),this.$form=l(this.ui.form);var i={};i[bu_navman_settings.confirmLinkBtn]=this.save.bind(this),i[bu_navman_settings.cancelLinkBtn]=this.cancel.bind(this),this.$el.dialog({autoOpen:!1,buttons:i,minWidth:400,width:500,modal:!0,resizable:!1}),l(document.body).on("click",".ui-widget-overlay, .ui-widget",this.stopPropagation),l(this.ui.addBtn).on("click",this.add.bind(this)),d.listenFor("postSelected",this.onPostSelected.bind(this)),d.listenFor("postDeselected",this.onPostDeselected.bind(this)),d.listenFor("postsDeselected",this.onPostDeselected.bind(this))},add:function(t){t.preventDefault(),t.stopPropagation();var i,e="";l(t.currentTarget).parent("li").hasClass("disabled")?(i=d.getSelectedPost(),e=bu_navman_settings.noLinksNotice,i&&bu_navman_settings.linksPostType===i.post_type?e=bu_navman_settings.noChildLinkNotice+"\n\n"+bu_navman_settings.createLinkNotice:n.settings.isSectionEditor?e=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice:n.settings.allowTop||(e=bu_navman_settings.noTopLevelNotice+"\n\n"+bu_navman_settings.createLinkNotice+"\n\n"+bu_navman_settings.allowTopNotice),alert(e)):(this.data.currentLink={post_status:"new",post_type:bu_navman_settings.linksPostType,post_meta:{}},this.$el.dialog("option","title",bu_navman_settings.addLinkDialogTitle).dialog("open"))},edit:function(t){l(this.ui.urlField).prop("value",t.post_content),l(this.ui.labelField).prop("value",t.post_title),"new"===t.post_meta.bu_link_target?l(this.ui.targetNewField).prop("checked",!0):l(this.ui.targetSameField).prop("checked",!0),this.data.currentLink=t,this.$el.dialog("option","title",bu_navman_settings.editLinkDialogTitle).dialog("open")},save:function(t){var i,e,n;t.preventDefault(),t.stopPropagation(),this.$form.valid()&&((i=this.data.currentLink).post_content=l(this.ui.urlField).prop("value"),i.post_title=l(this.ui.labelField).prop("value"),i.url=i.post_content,i.post_meta.bu_link_target=l("input[name='editlink_target']:checked").prop("value"),n=d.getSelectedPost(),i.post_parent=n?n.ID:0,i.menu_order=1,"new"!==i.post_status||i.ID?(e=d.updatePost(i),this.broadcast("linkUpdated",[e])):(e=d.insertPost(i),this.broadcast("linkInserted",[e])),this.clear(),this.$el.dialog("close"))},cancel:function(t){t.preventDefault(),t.stopPropagation(),this.$el.dialog("close"),this.clear()},clear:function(){l(this.ui.urlField).attr("value",""),l(this.ui.labelField).attr("value",""),l(this.ui.targetSameField).attr("checked","checked"),l(this.ui.targetNewField).removeAttr("checked"),this.data.currentLink=null},onPostSelected:function(t){var i=!0;t.post_type==bu_navman_settings.linksPostType&&(i=!1),(i=bu.hooks.applyFilters("navmanCanAddLink",i,t,d))?l(this.ui.addBtn).parent("li").removeClass("disabled"):l(this.ui.addBtn).parent("li").addClass("disabled")},onPostDeselected:function(){var t=this.data.allowTop;(t=bu.hooks.applyFilters("navmanCanAddLink",t))?l(this.ui.addBtn).parent("li").removeClass("disabled"):l(this.ui.addBtn).parent("li").addClass("disabled")},stopPropagation:function(t){t.stopPropagation()}},window.onbeforeunload=function(){if(n.data.dirty)return bu_navman_settings.unloadWarning}}(jQuery),jQuery(document).ready(function(t){"use strict";bu.plugins.navigation.views.Navman.initialize()});