if("undefined"==typeof bu||"undefined"==typeof bu.plugins||"undefined"==typeof bu.plugins.navigation)throw new TypeError("BU Navigation Metabox dependencies have not been met!");!function(a){bu.plugins.navigation.views=bu.plugins.navigation.views||{};var b,c;b=bu.plugins.navigation.views.Metabox={el:"#bunavattrsdiv",ui:{treeContainer:"#edit-post-tree",moveBtn:"#move-post-button",breadcrumbs:"#bu-post-breadcrumbs"},inputs:{label:'[name="nav_label"]',visible:'[name="nav_display"]',postID:'[name="post_ID"]',originalStatus:'[name="original_post_status"]',parent:'[name="parent_id"]',order:'[name="menu_order"]',autoDraft:'[name="auto_draft"]'},data:{modalTree:void 0,breadcrumbs:"",label:""},initialize:function(){var b,c,d,e,f;return this.settings=nav_metabox_settings,this.settings.el=this.ui.treeContainer,this.settings.isNewPost=1==a(this.inputs.autoDraft).val()?!0:!1,b=a(this.inputs.originalStatus).val(),c=parseInt(a(this.inputs.parent).val(),10),d=parseInt(a(this.inputs.order).val(),10),e=a(this.inputs.label).val()||"(no title)",f=a(this.inputs.visible).attr("checked")||!1,this.settings.currentPost={ID:parseInt(a(this.inputs.postID).val(),10),post_title:e,post_status:"auto-draft"==b?"new":b,post_parent:c,menu_order:d,post_meta:{excluded:!f},originalParent:c,originalExclude:!f},a(this.ui.treeContainer).addClass("current-post-status-"+b),this.$el=a(this.el),this.loadNavTree(),this.attachHandlers(),this},loadNavTree:function(){"undefined"==typeof this.data.modalTree&&(this.data.modalTree=ModalPostTree(this.settings),this.data.modalTree.listenFor("locationUpdated",a.proxy(this.onLocationUpdated,this)))},attachHandlers:function(){this.$el.delegate(this.ui.moveBtn,"click",this.data.modalTree.open),this.$el.delegate(this.inputs.label,"blur",a.proxy(this.onLabelChange,this)),this.$el.delegate(this.inputs.visible,"click",a.proxy(this.onToggleVisibility,this))},onLabelChange:function(){var b=a(this.inputs.label).attr("value");this.settings.currentPost.post_title=b,c.updatePost(this.settings.currentPost),c.save(),this.updateBreadcrumbs(this.settings.currentPost)},onToggleVisibility:function(b){var d=a(b.target).attr("checked"),e=nav_metabox_settings.topLevelDisabled+"\n\n"+nav_metabox_settings.topLevelNotice;d&&!this.isAllowedInNavigationLists(this.settings.currentPost)?(b.preventDefault(),this.notify(e)):(this.settings.currentPost.post_meta.excluded=!d,c.updatePost(this.settings.currentPost),c.save())},onLocationUpdated:function(b){a(this.inputs.parent).val(b.post_parent),a(this.inputs.order).val(b.menu_order),this.updateBreadcrumbs(b),this.settings.currentPost=b},updateBreadcrumbs:function(b){var d,e,f;d=c.getAncestors(b.ID),e=a(this.ui.breadcrumbs).clone().empty(),a.each(d,function(b,c){f=a("<li></li>").html(c),b<d.length-1?f.append("<ul></ul>"):f.addClass("current"),0===b?e.append(f):e.find("ul").last().append(f)}),e.find("li").length>1?a(this.ui.breadcrumbs).replaceWith(e):a(this.ui.breadcrumbs).html('<li class="current">'+nav_metabox_settings.topLevelLabel+"</li>")},isAllowedInNavigationLists:function(a){var b=a.originalExclude===!1&&0===a.originalParent;return b||0!==a.post_parent?!0:this.settings.allowTop},notify:function(a){alert(a)}},ModalPostTree=bu.plugins.navigation.views.ModalPostTree=function(b){var d={},e=d.conf={treeContainer:"#edit-post-tree",toolbarContainer:".post-placement-toolbar",navSaveBtn:"#bu-post-placement-save",navCancelBtn:"#bu-post-placement-cancel",treeDragContainer:"#TB_ajaxContent"};e=a.extend(e,b),bu.signals.register(d);var f,g=function(){return c=d.tree=bu.plugins.navigation.tree("edit_post",e),f=a(e.toolbarContainer),f.delegate(e.navSaveBtn,"click",d.onUpdateLocation),f.delegate(e.navCancelBtn,"click",d.onCancelMove),e.lazyLoad?c.listenFor("lazyLoadComplete",c.save):c.listenFor("postsSelected",c.save),d};return d.open=function(b){var e=a(window).width(),f=a(window).height(),g=e>720?720:e,h=b.target.title||b.target.name||null,i=b.target.href||b.target.alt,j=b.target.rel||!1;return i=i.replace(/&width=[0-9]+/g,""),i=i.replace(/&height=[0-9]+/g,""),i=i+"&width="+(g-80)+"&height="+(f-85),tb_show(h,i,j),d.scrollToSelection(),a("#TB_window").bind("unload tb_unload",function(){d.saving?d.saving=!1:c.restore()}),!1},d.scrollToSelection=function(){var b,c,d,f,g;b=a(e.treeContainer),c=b.jstree("get_selected"),c.length&&(d=a(e.treeDragContainer),f=d.innerHeight(),g=c.position().top+c.height()/2-f/2,g>0&&d.scrollTop(g))},d.onUpdateLocation=function(a){a.preventDefault(),d.broadcast("locationUpdated",[c.getCurrentPost()]),c.save(),d.saving=!0,tb_remove()},d.onCancelMove=function(a){a.preventDefault(),tb_remove()},g(b)}}(jQuery);var tb_position;!function(a){tb_position=function(){var b=a("#TB_window"),c=a(window).width(),d=a(window).height(),e=c>720?720:c,f=0;return a("body.admin-bar").length&&(f=28),b.size()&&(b.width(e-50).height(d-45-f),a("#TB_iframeContent").width(e-50).height(d-75-f),a("#TB_ajaxContent").width(e-80).height(d-92-f),b.css({"margin-left":"-"+parseInt((e-50)/2,10)+"px"}),"undefined"!=typeof document.body.style.maxWidth&&b.css({top:20+f+"px","margin-top":"0"})),a("a.thickbox").each(function(){var b=a(this).attr("href");b&&(b=b.replace(/&width=[0-9]+/g,""),b=b.replace(/&height=[0-9]+/g,""),a(this).attr("href",b+"&width="+(e-80)+"&height="+(d-85-f)))})},a(window).resize(function(){tb_position()})}(jQuery),jQuery(document).ready(function(){bu.plugins.navigation.metabox=bu.plugins.navigation.views.Metabox.initialize()});